<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Card√°pio Inteligente (v6.2)</title>

  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* seu CSS aqui (ok manter igual) */
  </style>
</head>
<body class="bg-[#0a0a1a] text-slate-200">
  <div id="root"></div>

  <!-- TODO: cole aqui dentro TODO o seu JS/JSX (exatamente como j√° est√°) -->
  <script type="text/babel">
    /* SEU C√ìDIGO AQUI */
  </script>
</body>
</html>

  <!-- CONFIG SUPABASE -->
<script type="text/babel">
  const SUPABASE_URL = 'https://grnwskvvbglclnijbgdq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdybndza3Z2YmdsY2xuaWpiZ2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MDA4OTEsImV4cCI6MjA3NTM3Njg5MX0.MqkWLIvU9DQHzudm-OLkSKEwmwxUDUBuGgHU_9F1baM';
  // (o restante do seu script permanece igual)
</script>
    
    if (SUPABASE_URL.includes('YOUR_') || SUPABASE_ANON_KEY.includes('YOUR_')) {
      alert("‚ö†Ô∏è ERRO DE CONFIGURA√á√ÉO: Por favor, substitua 'YOUR_SUPABASE_URL' e 'YOUR_ANON_KEY' no c√≥digo. O app n√£o funcionar√° sem as credenciais Supabase.");
      window.supabase = { createClient: () => ({ auth: { getSession: () => ({ data: {} }), onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => {} } } }), signInWithPassword: () => ({ error: { message: 'Configura√ß√£o Incompleta.' } }), signUp: () => ({ error: { message: 'Configura√ß√£o Incompleta.' } }), signOut: () => {} } }) };
    }
    
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const AVATAR_BUCKET = 'avatars';
    // ===================================================================

    // ===== UTILS / C√ÅLCULOS / STORAGE (Mantidos) =====
    const KCAL_PER_G = { protein: 4, carbs: 4, fats: 9 };
    const round = (n, d = 0) => Math.round(n * 10**d) / 10**d;
    const toNum = v => Number.isFinite(+v) ? +v : 0;

    const NS = "cardapio_v6_0";
    const PROFILE_STORAGE_KEY = `${NS}_profile`;
    const ALL_DAYS_STORAGE_KEY = `${NS}_all_days`;
    const SLOTS_STORAGE_KEY = `${NS}_slotkeys`;
    const CURRENT_DAY_ID_STORAGE_KEY = `${NS}_current_day_id`;
    const FAVORITES_STORAGE_KEY = `${NS}_favorites`;
    const USAGE_STORAGE_KEY = `${NS}_usage`;
    const JSON_CACHE_KEY = `${NS}_lib_cache`;
    const INITIAL_DAY_ID = 'day-1';
    const INITIAL_SLOT_KEYS = ['slot-1','slot-2','slot-3','slot-4'];
    
    function calcBMR({ sex, weight, height, age }) {
      const s = sex === "F" ? -161 : 5;
      return 10 * weight + 6.25 * height - 5 * age + s;
    }
    function calcTDEE(bmr, activity) {
      const f = { sedentary:1.2, light:1.375, moderate:1.55, active:1.725, very:1.9 };
      return bmr * (f[activity] || 1.55);
    }
    function adjustForGoal(tdee, goal) {
      if (goal === "loss") return tdee * 0.85;
      if (goal === "gain") return tdee * 1.10;
      if (goal === "recomp") return tdee * 0.95;
      return tdee;
    }
    function deriveMacroTargets({ weight, calories }) {
      const protein = 1.8 * weight;
      const fat = 0.8 * weight;
      const kcalP = protein * KCAL_PER_G.protein;
      const kcalF = fat * KCAL_PER_G.fats;
      const kcalC = Math.max(0, calories - kcalP - kcalF);
      const carbs = kcalC / KCAL_PER_G.carbs;
      return { protein: round(protein), fats: round(fat), carbs: round(carbs) };
    }
    function calcBodyFat({ sex, height, neck, waist, hip, weight }) {
      const h = +height || 0, n = +neck || 0, w = +waist || 0, q = +hip || 0;
      if (h <= 0 || n <= 0 || w <= 0 || (sex === 'F' && q <= 0)) return { bf:null, fm:null, lm:null };
      const log10 = (x) => Math.log(x) / Math.LN10;
      let bf;
      if (sex === 'F') {
        const x = w + q - n;
        if (x <= 0) return { bf:null, fm:null, lm:null };
        bf = 163.205 * log10(x) - 97.684 * log10(h) - 78.387;
      } else {
        const x = w - n;
        if (x <= 0) return { bf:null, fm:null, lm:null };
        bf = 86.010 * log10(x) - 70.041 * log10(h) + 36.76;
      }
      bf = Math.min(60, Math.max(3, bf));
      const wt = +weight || 0;
      const fm = wt * (bf / 100);
      const lm = wt - fm;
      const round1 = (v) => Math.round(v * 10) / 10;
      return { bf: round1(bf), fm: round1(fm), lm: round1(lm) };
    }
    function normalizeOnBlur(key, value) {
      const INPUT_RANGES = { age: { min: 10, max: 120, step: 1 }, weight: { min: 30, max: 300, step: 0.5 }, height: { min: 100, max: 250, step: 1 }, neck: { min: 20, max: 60, step: 0.5 }, waist:{ min: 40, max: 150, step: 0.5 }, hip:  { min: 50, max: 150, step: 0.5 }, };
      const r = INPUT_RANGES[key];
      let n = toNum(value);
      if (r) {
        if (n !== 0 && n < r.min) n = r.min;
        if (n > r.max) n = r.max;
      }
      return n;
    }
    function loadState(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (raw === null || raw === "undefined") return fallback;
        return JSON.parse(raw);
      } catch { return fallback; }
    }
    function saveState(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    }
    function nsKey(base, uid) { return `${base}__${uid || 'anon'}`; }
    function loadStateNS(base, uid, fallback) { return loadState(nsKey(base, uid), fallback); }
    function saveStateNS(base, uid, value) { return saveState(nsKey(base, uid), value); }
    const DEFAULT_PROFILE = { sex: "M", age: 33, weight: 73, height: 170, activity: "moderate", goal: "recomp", neck: 36, waist: 85, hip: 95, photoUrl: 'https://placehold.co/100x100/1E293B/E2E8F0?text=Foto', photoUpdatedAt: null, unitSystem: "metric" };
    const getInitialDayState = (keys) => {
      const base = keys.reduce((acc, k) => (acc[k] = [], acc), {});
      return { ...base, meta: { waterMl: 0, sleepH: 0 } };
    };

    // ===================================================================
    // üü¢ L√ìGICA DE BUSCA DA BIBLIOTECA: AGORA PRIORIZA SUPABASE
    // ===================================================================
    
    const JSON_URL = new URL('alimentos.json', location.href); 
    function inferBlockByKcal(kcal) {
      const k = Number(kcal) || 0;
      const within = (t) => Math.abs(k - t) <= 50;
      if (within(250)) return "250";
      if (within(350)) return "350";
      if (within(500)) return "500";
      if (within(750)) return "750";
      return "250";
    }

    function normalizeLocalItems(data) {
      if (!data || !Array.isArray(data.items)) return [];
      return data.items.map((it, i) => {
        const protein = Number(it.protein) || 0;
        const carbs   = Number(it.carbs)   || 0;
        const fats    = Number(it.fats)    || 0;
        const kcal    = Number(it.kcal)    || (protein*4 + carbs*4 + fats*9);
        const block   = (it.block != null && it.block !== "") ? String(it.block).trim() : inferBlockByKcal(kcal);
        return {
          id: it.id || `ext_${i}`, name: it.name || it.nome || 'Item', block,
          tags: Array.isArray(it.tags) ? it.tags : [],
          ingredients: [{ name: it.name || it.nome || 'Item', baseKcal: kcal, protein, carbs, fats, portion: 1 }]
        };
      });
    }

    async function fetchLocalJsonFallback(force=false) {
      try {
        const cache = loadState(JSON_CACHE_KEY, null);
        if (!force && cache?.ts && cache?.items) {
          console.log("Biblioteca carregada do cache local (fallback).");
          return cache.items;
        }
        const u = new URL(JSON_URL); u.searchParams.set('_', Date.now());
        const res = await fetch(u, { cache: 'no-store' });
        if (!res.ok) throw new Error();
        const data = await res.json();
        const items = normalizeLocalItems(data);
        saveState(JSON_CACHE_KEY, { ts: Date.now(), items });
        console.log("Biblioteca carregada do arquivo JSON local (fallback).");
        return items;
      } catch { 
        return loadState(JSON_CACHE_KEY, {items:[]}).items || []; 
      }
    }

    // Nova fun√ß√£o de busca via Supabase (Priorit√°ria)
    async function fetchExternalMealsSafe({ force=false } = {}) {
      if (SUPABASE_URL.includes('YOUR_')) {
        console.warn("Chaves Supabase n√£o configuradas. Usando apenas o arquivo local.");
        return await fetchLocalJsonFallback(true);
      }

      try {
        const { data, error } = await sb
          .from('refeicoes_biblioteca')
          .select('id, nome, kcal, proteina, carboidrato, gordura, bloco, tags, created_by')
          .order('nome', { ascending: true });

        if (error || !data) {
          console.error("Erro ao carregar do Supabase. Tentando fallback local:", error?.message);
          return await fetchLocalJsonFallback(true);
        }

        if (data.length === 0) {
          console.warn("Nenhum dado encontrado no Supabase. Tentando fallback local.");
          return await fetchLocalJsonFallback(true);
        }

        return data.map(it => {
          const protein = Number(it.proteina) || 0;
          const carbs   = Number(it.carboidrato) || 0;
          const fats    = Number(it.gordura) || 0;
          const kcal    = Number(it.kcal)    || (protein*4 + carbs*4 + fats*9);
          const block   = String(it.bloco || inferBlockByKcal(kcal)).trim();

          return {
            id: it.id || `db_${it.nome}`,
            name: it.nome || 'Item do DB',
            block,
            tags: Array.isArray(it.tags) ? it.tags : [],
            created_by: it.created_by, // Adicionado para checar permiss√£o de DELETE
            ingredients: [{ name: it.nome || 'Item', baseKcal: kcal, protein, carbs, fats, portion: 1 }]
          };
        });

      } catch (e) {
        console.error("Exce√ß√£o grave na busca Supabase. Tentando fallback local:", e);
        return await fetchLocalJsonFallback(true);
      }
    }

    // ===================================================================
    // üü¢ FUN√á√ÉO SUPABASE: ADICIONAR REFEI√á√ÉO (v6.2) - HARDENING
    // ===================================================================

    async function addMealToDB({ name, kcal, protein, carbs, fats, block, tags }) {
      if (SUPABASE_URL.includes('YOUR_')) {
          return { success: false, error: 'Erro de Configura√ß√£o: Chaves Supabase n√£o definidas.' };
      }
      
      const tagArray = tags.split(',').map(t => t.trim()).filter(t => t.length > 0);

      // ‚úÖ Passo 3: Hardening no INSERT - Deixe 'created_by' para o trigger/RLS preencher automaticamente.
      const payload = {
          nome: name,
          kcal: Number(kcal) || 0,
          proteina: Number(protein) || 0,
          carboidrato: Number(carbs) || 0,
          gordura: Number(fats) || 0,
          bloco: block,
          tags: tagArray
          // created_by √© omitido aqui ou pode ser explicitamente session?.user?.id se preferir
      };

      const { data, error } = await sb
          .from('refeicoes_biblioteca')
          .insert(payload)
          .select('id, nome, kcal, proteina, carboidrato, gordura, bloco, tags, created_by')
          .single(); 

      if (error) {
          console.error("Erro ao inserir no Supabase:", error);
          return { success: false, error: error.message };
      }

      // Converte o item inserido de volta para o formato de estado local
      const item = data;
      const meal = {
            id: item.id,
            name: item.nome,
            block: item.bloco,
            tags: item.tags,
            created_by: item.created_by, // Inclui o created_by retornado
            ingredients: [{ 
                name: item.nome, 
                baseKcal: item.kcal, 
                protein: item.proteina, 
                carbs: item.carboidrato, 
                fats: item.gordura, 
                portion: 1 
            }]
      };
      
      return { success: true, item: meal };
    }

    // ===================================================================
    // üü¢ FUN√á√ÉO SUPABASE: EXCLUIR REFEI√á√ÉO (v6.2) - NOVO
    // ===================================================================
    
    async function deleteMealFromDB(mealId) {
      if (!mealId) return { ok:false, error: 'id inv√°lido' };

      // opcional: confirma√ß√£o simples
      if (!confirm('Excluir esta refei√ß√£o definitivamente?')) {
        return { ok:false, canceled:true };
      }

      const { error } = await sb
        .from('refeicoes_biblioteca')
        .delete()
        .eq('id', mealId);

      if (error) {
        console.error('Erro ao excluir refei√ß√£o', error);
        alert('‚ö†Ô∏è Erro ao excluir: ' + (error.message || 'desconhecido'));
        return { ok:false, error };
      }

      // Se voc√™ mant√©m um cache local (ex.: meals state), remova o item aqui:
      // setMeals(list => list.filter(m => m.id !== mealId));
      // Ou, se voc√™ sempre refaz o fetch ap√≥s muta√ß√µes, apenas dispare o refresh:
      if (typeof fetchExternalMealsSafe === 'function') {
        await fetchExternalMealsSafe({ force: true });
      }

      return { ok:true };
    }

    // ===== Web Worker de compress√£o (Mantido) =====
    const workerSrc = `
      self.onmessage = async (e) => {
        const { file } = e.data;
        try {
          const arr = await file.arrayBuffer();
          const blob = new Blob([arr]);
          const bmp = await createImageBitmap(blob);
          const size = 512;
          const minSide = Math.min(bmp.width, bmp.height);
          const sx = Math.floor((bmp.width - minSide)/2);
          const sy = Math.floor((bmp.height - minSide)/2);
          const canvas = new OffscreenCanvas(size, size);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(bmp, sx, sy, minSide, minSide, 0, 0, size, size);
          const webp = await canvas.convertToBlob({ type: 'image/webp', quality: 0.85 });
          self.postMessage({ ok:true, blob:webp }, [webp]);
        } catch(err){
          self.postMessage({ ok:false, error: err?.message || 'compress-failed' });
        }
      };
    `;
    const workerURL = URL.createObjectURL(new Blob([workerSrc], { type: "text/javascript" }));

    // ===== APP (L√≥gica do Componente Principal - Mantida) =====
    function App() {
      const uidRef = useRef('anon');
      const [profile, setProfile] = useState(() => loadStateNS(PROFILE_STORAGE_KEY, uidRef.current, DEFAULT_PROFILE));
      const [isProfileLocked, setIsProfileLocked] = useState(false);
      const [slotKeys, setSlotKeys] = useState(() => {
        const k = loadStateNS(SLOTS_STORAGE_KEY, uidRef.current, INITIAL_SLOT_KEYS);
        return Array.isArray(k) && k.length ? k : INITIAL_SLOT_KEYS;
      });
      const [currentDayId, setCurrentDayId] = useState(() => loadStateNS(CURRENT_DAY_ID_STORAGE_KEY, uidRef.current, INITIAL_DAY_ID));
      const [allDays, setAllDays] = useState(() => {
        const d = loadStateNS(ALL_DAYS_STORAGE_KEY, uidRef.current, {});
        if (!Object.keys(d).length || !d[INITIAL_DAY_ID]) return { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) };
        return d;
      });
      const day = allDays[currentDayId] || getInitialDayState(slotKeys);
      const [favorites, setFavorites] = useState(() => new Set(loadState(FAVORITES_STORAGE_KEY, [])));
      const [usage, setUsage] = useState(() => loadStateNS(USAGE_STORAGE_KEY, uidRef.current, {}));

      useEffect(()=> saveStateNS(PROFILE_STORAGE_KEY, uidRef.current, profile), [profile]);
      useEffect(()=> saveStateNS(ALL_DAYS_STORAGE_KEY, uidRef.current, allDays), [allDays]);
      useEffect(()=> saveStateNS(CURRENT_DAY_ID_STORAGE_KEY, uidRef.current, currentDayId), [currentDayId]);
      useEffect(()=> saveStateNS(SLOTS_STORAGE_KEY, uidRef.current, slotKeys), [slotKeys]);
      useEffect(()=> saveState(FAVORITES_STORAGE_KEY, Array.from(favorites)), [favorites]);
      useEffect(()=> saveStateNS(USAGE_STORAGE_KEY, uidRef.current, usage), [usage]);

      const [session, setSession] = useState(null);
      const [authReady, setAuthReady] = useState(false);
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [syncing, setSyncing] = useState(false);
      const [typingNumeric, setTypingNumeric] = useState(false);
      const [hydrated, setHydrated] = useState(false); 
      const lastSnapRef = useRef(null);
      const debounceRef = useRef(null);

      useEffect(() => {
        let unsub = null;
        (async () => {
          if (!window.supabase || SUPABASE_URL.includes('YOUR_')) { setAuthReady(true); return; } 
          const { data } = await sb.auth.getSession();
          setSession(data.session || null);
          setAuthReady(true);
          const sub = sb.auth.onAuthStateChange((_e, s) => {
            setSession(s); setAuthReady(true);
          });
          unsub = sub.data.subscription;
        })();
        return () => unsub?.unsubscribe();
      }, []);

      useEffect(() => {
        const uid = session?.user?.id || 'anon';
        if (uidRef.current === uid) return;
        uidRef.current = uid;
        setHydrated(false);

        setProfile(loadStateNS(PROFILE_STORAGE_KEY, uid, DEFAULT_PROFILE));
        const k = loadStateNS(SLOTS_STORAGE_KEY, uid, INITIAL_SLOT_KEYS);
        setSlotKeys(Array.isArray(k) && k.length ? k : INITIAL_SLOT_KEYS);
        const d = loadStateNS(ALL_DAYS_STORAGE_KEY, uid, {});
        setAllDays(Object.keys(d).length ? d : { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) });
        setCurrentDayId(loadStateNS(CURRENT_DAY_ID_STORAGE_KEY, uid, INITIAL_DAY_ID));
        setFavorites(new Set(loadState(FAVORITES_STORAGE_KEY, []))); 
        setUsage(loadStateNS(USAGE_STORAGE_KEY, uid, {}));
      }, [session]);

      const [externalMeals, setExternalMeals] = useState([]);
      useEffect(()=>{ fetchExternalMealsSafe({ force: false }).then(setExternalMeals); }, []);
      const refreshLibrary = async ()=> setExternalMeals(await fetchExternalMealsSafe({ force: true }));

      const [search, setSearch] = useState("");
      const [searchInIngredients, setSearchInIngredients] = useState(true);
      const [selectedBlock, setSelectedBlock] = useState("all");
      const [activeTags, setActiveTags] = useState([]);
      const [onlyFavs, setOnlyFavs] = useState(false);
      const [orderBy, setOrderBy] = useState("relevance"); 
      const [minProfile, setMinProfile] = useState(false);
      const [minMacros, setMinMacros] = useState(false);
      const [minLib, setMinLib] = useState(false);
      const [minDay, setMinDay] = useState(false);

      const isMetric = true;
      const unit = { weight: "kg", length: "cm" };

      const safeProfile = useMemo(() => {
        const base = { ...profile, unitSystem: "metric" };
        return {
          ...base,
          age: toNum(base.age), weight: toNum(base.weight), height: toNum(base.height),
          neck: toNum(base.neck), waist: toNum(base.waist), hip: toNum(base.hip),
        };
      }, [profile]);

      const bmr = useMemo(()=> calcBMR(safeProfile), [safeProfile]);
      const tdee = useMemo(()=> calcTDEE(bmr, safeProfile.activity), [bmr, safeProfile.activity]);
      const targetCalories = useMemo(()=> round(adjustForGoal(tdee, safeProfile.goal)), [tdee, safeProfile.goal]);
      const macroTargets = useMemo(()=> deriveMacroTargets({ weight: safeProfile.weight, calories: targetCalories }), [safeProfile.weight, targetCalories]);
      const body = useMemo(()=> calcBodyFat(safeProfile), [safeProfile.sex, safeProfile.height, safeProfile.neck, safeProfile.waist, safeProfile.hip, safeProfile.weight]);

      const LIB_WITH_TOTALS = useMemo(()=> {
        const enriched = externalMeals.map(m => {
          const totals = (m.ingredients||[]).reduce((a, e) => {
            const p=+e.protein||0, c=+e.carbs||0, f=+e.fats||0;
            const base=+e.baseKcal || (p*4+c*4+f*9);
            const por=+e.portion||1;
            a.kcal+=base*por; a.protein+=p*por; a.carbs+=c*por; a.fats+=f*por;
            return a;
          }, { kcal:0, protein:0, carbs:0, fats:0 });
          return { ...m, ...totals, fav: favorites.has(m.id), used: usage[m.id]||0 };
        });
        let list = enriched.filter(m => {
          const blockOk  = selectedBlock === "all" || (String(m.block).trim() === String(selectedBlock).trim());
          const tagOk    = activeTags.length === 0 || activeTags.every(t => (m.tags||[]).includes(t));
          const term = search.trim().toLowerCase();
          const inName = (m.name || "").toLowerCase().includes(term);
          const inIngs = searchInIngredients && (m.ingredients||[]).some(ing => (ing.name||"").toLowerCase().includes(term));
          const searchOk = term ? (inName || inIngs) : true;
          const favOk = !onlyFavs || m.fav;
          return blockOk && tagOk && searchOk && favOk;
        });
        if (orderBy === "kcal-asc") list.sort((a,b)=> a.kcal - b.kcal);
        else if (orderBy === "kcal-desc") list.sort((a,b)=> b.kcal - a.kcal);
        else if (orderBy === "protein") list.sort((a,b)=> b.protein - b.protein);
        else if (orderBy === "most-used") list.sort((a,b)=> (b.used||0) - (a.used||0));
        return list;
      }, [externalMeals, favorites, usage, selectedBlock, activeTags, search, searchInIngredients, onlyFavs, orderBy]);

      function sumIngredients(list) {
        return list.reduce((acc, ing) => {
          if (ing.included === false) return acc;
          const p=+ing.protein||0, c=+ing.carbs||0, f=+ing.fats||0;
          const base=+ing.baseKcal || (p*4+c*4+f*9);
          const por=+ing.portion||1;
          acc.kcal+=base*por; acc.protein+=p*por; acc.carbs+=c*por; acc.fats+=f*por;
          return acc;
        }, { kcal:0, protein:0, carbs:0, fats:0 });
      }
      const slotTotals = useMemo(() => {
        const t = {};
        slotKeys.forEach(k => {
          const meals = day[k] || [];
          const s = meals.reduce((acc, meal) => {
            const partial = sumIngredients(meal.ingredients || []);
            acc.kcal += partial.kcal; acc.protein += partial.protein; acc.carbs += partial.carbs; acc.fats += partial.fats;
            return acc;
          }, {kcal:0,protein:0,carbs:0,fats:0});
          t[k]=s;
        });
        return t;
      }, [day, slotKeys]);

      const totals = useMemo(()=> {
        return Object.values(slotTotals).reduce((a,b)=>({kcal:a.kcal+b.kcal,protein:a.protein+b.protein,carbs:a.carbs+b.carbs,fats:a.fats+b.fats}),{kcal:0,protein:0,carbs:0,fats:0});
      }, [slotTotals]);

      const getSlotLabel = (k)=> `Refei√ß√£o ${slotKeys.indexOf(k)+1}`;
      const updateDay = (next)=> setAllDays(prev => ({ ...prev, [currentDayId]: next }));
      const getMeta = (d) => ({ waterMl: 0, sleepH: 0, ...(d?.meta || {}) });

      const addWater = (ml) => {
        const meta = getMeta(day);
        const next = { ...day, meta: { ...meta, waterMl: Math.max(0, (meta.waterMl || 0) + ml) } };
        updateDay(next);
      };
      const setWater = (ml) => {
        const meta = getMeta(day);
        const next = { ...day, meta: { ...meta, waterMl: Math.max(0, +ml || 0) } };
        updateDay(next);
      };
      const setSleep = (h) => {
        const meta = getMeta(day);
        const val = Math.min(12, Math.max(0, +h || 0));
        const next = { ...day, meta: { ...meta, sleepH: val } };
        updateDay(next);
      };
      const deepCopy = (obj) => JSON.parse(JSON.stringify(obj));

      const addTo = (slotKey, meal)=> {
        const baseIngredients = (meal.ingredients||[]).map(x=>({...x, portion:1, included:true}));
        const entry = {
          mealId: meal.id, name: meal.name, isLocked:false,
          ingredients: deepCopy(baseIngredients),
          originalIngredients: deepCopy(baseIngredients)
        };
        updateDay({ ...day, [slotKey]: [...(day[slotKey]||[]), entry] });
        setUsage(u => ({ ...u, [meal.id]: (u[meal.id]||0)+1 }));
      };

      const removeMeal = (slotKey, i)=> updateDay({ ...day, [slotKey]: day[slotKey].filter((_,idx)=> idx!==i) });
      const toggleLock = (slotKey, i)=> updateDay({ ...day, [slotKey]: day[slotKey].map((m,idx)=> idx===i ? ({...m, isLocked:!m.isLocked}) : m) });

      const duplicateMealTo = (fromKey, i, toKey) => {
        const m = day[fromKey][i];
        const copy = deepCopy(m);
        updateDay({ ...day, [toKey]: [...(day[toKey]||[]), copy] });
      };

      const updateIngredientPortion = (slotKey, i, j, por)=> updateDay({
        ...day,
        [slotKey]: day[slotKey].map((m,idx)=> idx!==i || m.isLocked ? m :
          ({...m, ingredients: m.ingredients.map((ing,k)=> k===j? {...ing, portion:Number(por)} : ing)}))
      });

      const toggleIngredientIncluded = (slotKey, i, j) => updateDay({
        ...day,
        [slotKey]: day[slotKey].map((m,idx)=> {
          if (idx!==i || m.isLocked) return m;
          const next = m.ingredients.map((ing,k)=> k===j ? ({...ing, included: !(ing.included!==false)}) : ing);
          return { ...m, ingredients: next };
        })
      });

      const resetMealIngredients = (slotKey, i) => updateDay({
        ...day,
        [slotKey]: day[slotKey].map((m,idx)=> {
          if (idx!==i) return m;
          return { ...m, ingredients: deepCopy(m.originalIngredients||[]), isLocked:false };
        })
      });

      const removeIngredient = (slotKey,i,j)=> updateDay({
        ...day,
        [slotKey]: day[slotKey].map((m,idx)=> {
          if (idx!==i || m.isLocked) return m;
          const next = m.ingredients.filter((_,k)=> k!==j);
          return next.length? {...m, ingredients:next} : {...m, ingredients:[]};
        })
      });

      const addQuickIngredient = (slotKey,i,ing) => updateDay({
        ...day,
        [slotKey]: day[slotKey].map((m,idx)=> {
          if (idx!==i || m.isLocked) return m;
          return { ...m, ingredients: [...m.ingredients, { ...ing, included:true }] };
        })
      });

      const addSlot = ()=> {
        if (slotKeys.length>=8) return;
        const key = `slot-${slotKeys.length+1}`;
        setSlotKeys(prev=> [...prev, key]);
        setAllDays(prev=>{
          const up = {...prev};
          Object.keys(up).forEach(did=> up[did] = { ...up[did], [key]: [] });
          return up;
        });
      };
      const removeSlot = (key)=> {
        if (slotKeys.length<=1) return;
        setSlotKeys(prev=> prev.filter(k=>k!==key));
        setAllDays(prev=>{
          const up = {...prev};
          Object.keys(up).forEach(did=> {
            const { [key]:_, ...rest } = up[did];
            up[did] = rest;
          });
          return up;
        });
      };
      const resetDay = ()=> updateDay(getInitialDayState(slotKeys));
      const duplicateCurrentDay = ()=> {
        const ids = Object.keys(allDays);
        const last = ids.reduce((mx,id)=> Math.max(mx, parseInt(id.split('-')[1]||'0',10)), 0);
        const newId = `day-${last+1}`;
        setAllDays(prev => ({ ...prev, [newId]: JSON.parse(JSON.stringify(day)) }));
        setCurrentDayId(newId);
      };
      const dayOptions = Object.keys(allDays).sort((a,b)=> (parseInt(a.split('-')[1]||'0',10) - parseInt(b.split('-')[1]||'0',10)));
      const getDayLabel = (id)=> `Dia ${dayOptions.indexOf(id)+1}`;

      async function signUpPassword() {
        if (!email || !password) return alert('Preencha e-mail e senha.');
        const { error } = await sb.auth.signUp({ email, password });
        if (error) return alert(error.message);
        alert('Conta criada! Se a confirma√ß√£o de e-mail estiver ativa, confirme e depois entre.');
      }
      async function signInPassword() {
        if (!email || !password) return alert('Preencha e-mail e senha.');
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) return alert(error.message);
      }
      async function signOut() {
        await sb.auth.signOut();
        uidRef.current = 'anon';
        const anonProfile = loadStateNS(PROFILE_STORAGE_KEY, 'anon', DEFAULT_PROFILE);
        setProfile({ ...anonProfile, photoUrl: DEFAULT_PROFILE.photoUrl, photoUpdatedAt: null });
        const k = loadStateNS(SLOTS_STORAGE_KEY, 'anon', INITIAL_SLOT_KEYS);
        setSlotKeys(Array.isArray(k) && k.length ? k : INITIAL_SLOT_KEYS);
        const d = loadStateNS(ALL_DAYS_STORAGE_KEY, 'anon', {});
        setAllDays(Object.keys(d).length ? d : { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) });
        setCurrentDayId(loadStateNS(CURRENT_DAY_ID_STORAGE_KEY, 'anon', INITIAL_DAY_ID));
        setFavorites(new Set(loadState(FAVORITES_STORAGE_KEY, [])));
        setUsage(loadStateNS(USAGE_STORAGE_KEY, 'anon', {}));
        setHydrated(true);
      }

      function snapshot() {
        return JSON.stringify({
          profile, allDays, slotKeys, currentDayId, favorites: Array.from(favorites), usage
        });
      }

      async function loadCloud() {
        if (!session) return;
        setSyncing(true);
        const { data, error } = await sb.from('user_state').select('*').eq('user_id', session.user.id).maybeSingle();
        if (error) { setSyncing(false); setHydrated(true); return; }
        if (!data) {
          await sb.from('user_state').insert({ user_id: session.user.id, profile, all_days: allDays, slot_keys: slotKeys, current_day_id: currentDayId, favorites: Array.from(favorites), usage });
          lastSnapRef.current = snapshot();
          setSyncing(false);
          setHydrated(true);
          return;
        }
        try {
          const p = data.profile || DEFAULT_PROFILE;
          const d = data.all_days || {};
          const s = Array.isArray(data.slot_keys)? data.slot_keys : INITIAL_SLOT_KEYS;
          const cid = data.current_day_id || INITIAL_DAY_ID;
          const fav = new Set(Array.isArray(data.favorites)? data.favorites : Array.from(favorites));
          const u = data.usage || usage;
          setProfile(p);
          setAllDays(Object.keys(d).length? d : { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) });
          setSlotKeys(s.length? s : INITIAL_SLOT_KEYS);
          setCurrentDayId(cid);
          setFavorites(fav);
          setUsage(u);
          lastSnapRef.current = JSON.stringify({ profile:p, allDays:d, slotKeys:s, currentDayId:cid, favorites:Array.from(fav), usage:u });
        } finally { setSyncing(false); setHydrated(true); }
      }

      async function saveCloudNow() {
        if (!session) return;
        setSyncing(true);
        await sb.from('user_state').upsert({
          user_id: session.user.id, profile, all_days: allDays, slot_keys: slotKeys, current_day_id: currentDayId, favorites: Array.from(favorites), usage, updated_at: new Date().toISOString()
        }, { onConflict: 'user_id' });
        lastSnapRef.current = snapshot();
        setSyncing(false);
      }

      useEffect(()=>{ if (session) loadCloud(); }, [session]);

      useEffect(() => {
        if (!session || !hydrated) return;
        if (typingNumeric) return;
        const snap = snapshot();
        if (snap === lastSnapRef.current) return;
        clearTimeout(debounceRef.current);
        debounceRef.current = setTimeout(() => { saveCloudNow(); }, 1200);
        return () => clearTimeout(debounceRef.current);
      }, [profile, allDays, slotKeys, currentDayId, favorites, usage, session, typingNumeric, hydrated]);

      function getExt(name) {
        const p = (name || '').split('.');
        return (p.length > 1 ? p.pop() : 'webp').toLowerCase();
      }
      async function onPhoto(e){
        if (isProfileLocked) return;
        const file = e.target.files?.[0];
        if (!file) return;
        if (!session?.user?.id) { return alert('Fa√ßa login para salvar sua foto.'); }

        const worker = new Worker(workerURL);
        const compressed = await new Promise((resolve) => {
          const t = setTimeout(()=> resolve(null), 15000);
          worker.onmessage = (ev) => {
            clearTimeout(t);
            if (ev.data?.ok) resolve(ev.data.blob);
            else resolve(null);
            worker.terminate();
          };
          worker.postMessage({ file });
        });

        const blob = compressed || file;
        const userId = session.user.id;
        const ext = getExt(file.name);
        const path = `u/${userId}/avatar.${ext === 'jpg' ? 'jpg' : 'webp'}`;

        const { error: upErr } = await sb.storage.from(AVATAR_BUCKET).upload(path, blob, { cacheControl: '3600', upsert: true });

        if (upErr) { alert('Falha no upload: ' + upErr.message); return; }

        const { data } = sb.storage.from(AVATAR_BUCKET).getPublicUrl(path);
        const publicUrl = data.publicUrl;

        const next = { ...profile, photoUrl: publicUrl, photoUpdatedAt: Date.now() };
        setProfile(next);

        await sb.from('user_state').upsert({ user_id: userId, profile: next, all_days: allDays, slot_keys: slotKeys, current_day_id: currentDayId, favorites: Array.from(favorites), usage, updated_at: new Date().toISOString() }, { onConflict: 'user_id' });
        lastSnapRef.current = snapshot();
      }

      const handleProfileChangeLive = (key, value) => {
        if (isProfileLocked) return;
        setTypingNumeric(/^(age|weight|height|neck|waist|hip)$/.test(key));
        setProfile(p => ({ ...p, [key]: value }));
      };
      const handleProfileBlur = (key) => {
        setTypingNumeric(false);
        setProfile(p => {
          if (['sex','activity','goal','photoUrl','unitSystem','photoUpdatedAt'].includes(key)) return p;
          return { ...p, [key]: normalizeOnBlur(key, p[key]) };
        });
      };

      const toggleFavorite = (id) => setFavorites(prev => {
        const next = new Set(prev);
        if (next.has(id)) next.delete(id); else next.add(id);
        return next;
      });

      const exportDay = () => {
        const payload = { version:"6.0", day: day, slotKeys };
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `cardapio_${currentDayId}.json`;
        a.click();
        setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
      };
      const importInputRef = useRef(null);
      const importDay = (file) => {
        const fr = new FileReader();
        fr.onload = () => {
          try {
            const data = JSON.parse(fr.result);
            if (!data?.day) throw new Error('Arquivo inv√°lido');
            const keys = Array.isArray(data.slotKeys) && data.slotKeys.length ? data.slotKeys : slotKeys;
            setSlotKeys(keys);
            updateDay(data.day);
            alert('Dia importado com sucesso!');
          } catch(err) {
            alert('Falha ao importar: ' + (err?.message||''));
          }
        };
        fr.readAsText(file);
      };

      // >>> LOGIN-GATE
      if (authReady && !session) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-[#0a0a1a] px-4">
            <div className="w-full max-w-md bg-slate-800/70 rounded-2xl p-6 border border-slate-700/60 shadow">
              <h1 className="text-xl font-semibold text-slate-100 mb-1 text-center">Card√°pio Inteligente</h1>
              <p className="text-xs text-slate-400 mb-5 text-center">
                Entre para acessar seu perfil, biblioteca e dias salvos.
              </p>

              <div className="flex flex-col gap-3">
                <input value={email} onChange={(e)=> setEmail(e.target.value)} placeholder="seu@email.com"
                       className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"/>
                <input type="password" value={password} onChange={(e)=> setPassword(e.target.value)} placeholder="senha"
                       className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"/>

                <button onClick={signInPassword} className="text-sm px-3 py-2 rounded border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10">Entrar</button>
                <button onClick={signUpPassword} className="text-sm px-3 py-2 rounded border border-blue-500 text-blue-300 hover:bg-blue-500/10">Criar conta</button>
              </div>

              <p className="text-[11px] text-slate-500 mt-4 text-center">
                Suas informa√ß√µes ficam salvas na nuvem e s√≥ aparecem quando voc√™ estiver logado.
              </p>
            </div>
          </div>
        );
      }
      // <<< LOGIN-GATE

      const WATER_GOAL = 3000;
      const SLEEP_GOAL = 8;
      const water = Math.max(0, day?.meta?.waterMl ?? 0);
      const sleep = Math.max(0, day?.meta?.sleepH ?? 0);
      const waterPct = Math.min(100, (water / WATER_GOAL) * 100);
      const sleepPct = Math.min(100, (sleep / SLEEP_GOAL) * 100);

      return (
        <div className="min-h-screen">
          <header className="px-6 py-5 border-b border-slate-700/60 sticky top-0 bg-[#0a0a1a]/90 backdrop-blur z-20">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">Card√°pio Inteligente</h1>
                <p className="text-sm text-slate-400">v6.2 ‚Ä¢ Adicionar Refei√ß√£o (Supabase)</p>
              </div>
              <div className="flex items-center gap-3 flex-wrap">
                <div className="flex items-center gap-2 text-xs">
                  <span className="text-slate-400">Unidades:</span>
                  <span className="px-2 py-1 rounded border border-slate-600 bg-slate-800/40">cm/kg</span>
                </div>

                {authReady && (!session ? (
                  <>
                    <input value={email} onChange={(e)=> setEmail(e.target.value)} placeholder="seu@email.com"
                           className="bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm w-44"/>
                    <input type="password" value={password} onChange={(e)=> setPassword(e.target.value)} placeholder="senha"
                           className="bg-slate-900 border border-slate-600 rounded px-3 py-1 text-sm w-36"/>
                    <button onClick={signInPassword} className="text-sm px-3 py-1 rounded border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10">Entrar</button>
                    <button onClick={signUpPassword} className="text-sm px-3 py-1 rounded border border-blue-500 text-blue-300 hover:bg-blue-500/10">Criar conta</button>
                  </>
                ) : (
                  <>
                    <span className="text-xs text-slate-400 hidden md:block">{session.user.email}</span>
                    <button onClick={saveCloudNow} disabled={syncing}
                            className={`text-sm px-3 py-1 rounded border ${syncing?'border-slate-700 text-slate-500':'border-blue-500 text-blue-300 hover:bg-blue-500/10'}`}>
                      {syncing ? (
                        <span className="inline-flex items-center gap-2">
                          <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10" strokeWidth="2" className="opacity-25"></circle>
                            <path d="M4 12a8 8 0 018-8" strokeWidth="2" className="opacity-75"></path>
                          </svg>
                          Salvando‚Ä¶
                        </span>
                      ) : 'Salvar agora'}
                    </button>
                    <button onClick={signOut} className="text-sm px-3 py-1 rounded border border-red-500 text-red-300 hover:bg-red-500/10">Sair</button>
                  </>
                ))}
                <a href="#biblioteca" className="hide-mobile text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40">Biblioteca</a>
                <a href="#meu-dia" className="hide-mobile text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40">Meu Dia</a>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* COLUNA PERFIL */}
            <div className="lg:col-span-1 flex flex-col gap-6">
              <Section
                title="Seu Perfil"
                right={
                  <div className="flex gap-2">
                    <button onClick={()=> setIsProfileLocked(v=>!v)}
                            className={`text-xs px-2 py-0.5 rounded border ${isProfileLocked ? 'border-red-500 text-red-300 bg-red-900/20' : 'border-emerald-500 text-emerald-300 bg-emerald-900/20'}`}>
                      {isProfileLocked ? 'Editar' : 'Trancar Perfil'}
                    </button>
                    <MinBtn on={minProfile} toggle={()=> setMinProfile(v=>!v)}/>
                  </div>
                }>
                <div className={`flex flex-col items-center mb-4 ${isProfileLocked ? 'opacity-70' : ''}`}>
                  <label htmlFor="photo" className={isProfileLocked?'':'cursor-pointer'}>
                    <img src={profile.photoUrl ? `${profile.photoUrl}?v=${encodeURIComponent(profile.photoUpdatedAt || '')}` : DEFAULT_PROFILE.photoUrl} alt="Foto"
                      className={`w-24 h-24 rounded-full object-cover border-4 border-slate-600 ${isProfileLocked?'':'hover:border-emerald-500'}`}
                      onError={(e)=> e.target.src = DEFAULT_PROFILE.photoUrl}
                    />
                    <input id="photo" type="file" accept="image/*" onChange={onPhoto} className="hidden" disabled={isProfileLocked}/>
                  </label>
                  <p className="text-xs text-slate-400 mt-2">{isProfileLocked?'Informa√ß√µes fixadas':'Toque para alterar foto (com compacta√ß√£o)'}</p>
                </div>

                {!minProfile && (
                  <>
                    <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                      <label className="flex flex-col gap-1">
                        <span>Sexo</span>
                        <select value={profile.sex} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('sex', e.target.value)} onBlur={()=> handleProfileBlur('sex')}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-2">
                          <option value="M">Masculino</option>
                          <option value="F">Feminino</option>
                        </select>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Idade</span>
                        <input type="number" value={profile.age} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('age', e.target.value)} onBlur={()=> handleProfileBlur('age')}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2" inputMode="decimal"/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Peso ({unit.weight})</span>
                        <input type="number" value={profile.weight} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('weight', e.target.value)} onBlur={()=> handleProfileBlur('weight')}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2" inputMode="decimal"/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Altura ({unit.length})</span>
                        <input type="number" value={profile.height} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('height', e.target.value)} onBlur={()=> handleProfileBlur('height')}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2" inputMode="decimal"/>
                      </label>
                    </div>

                    <span className="text-slate-300 font-semibold text-sm block mb-3">Medidas (p/ %Gordura)</span>
                    <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                      <label className="flex flex-col gap-1">
                        <span>Pesco√ßo ({unit.length})</span>
                        <input type="number" value={profile.neck} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('neck', e.target.value)} onBlur={()=> handleProfileBlur('neck')}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2" inputMode="decimal"/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Cintura ({unit.length})</span>
                        <input type="number" value={profile.waist} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('waist', e.target.value)} onBlur={()=> handleProfileBlur('waist')}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2" inputMode="decimal"/>
                      </label>
                      {profile.sex==='F' && (
                        <label className="flex flex-col gap-1 col-span-2">
                          <span>Quadril ({unit.length})</span>
                          <input type="number" value={profile.hip} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('hip', e.target.value)} onBlur={()=> handleProfileBlur('hip')}
                                 className="bg-slate-900 border border-slate-600 rounded px-2 py-2" inputMode="decimal"/>
                        </label>
                      )}
                    </div>

                    <div className="grid grid-cols-1 gap-3 text-sm">
                      <label className="flex flex-col gap-1">
                        <span>N√≠vel de Atividade</span>
                        <select value={profile.activity} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('activity', e.target.value)} onBlur={()=> handleProfileBlur('activity')}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-2">
                          <option value="sedentary">Sedent√°rio</option>
                          <option value="light">Leve (1‚Äì3x/sem)</option>
                          <option value="moderate">Moderado (3‚Äì5x/sem)</option>
                          <option value="active">Ativo (6‚Äì7x/sem)</option>
                          <option value="very">Muito ativo</option>
                        </select>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Objetivo</span>
                        <select value={profile.goal} disabled={isProfileLocked} onChange={(e)=> handleProfileChangeLive('goal', e.target.value)} onBlur={()=> handleProfileBlur('goal')}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-2">
                          <option value="loss">Emagrecer (d√©ficit)</option>
                          <option value="maintain">Manter</option>
                          <option value="gain">Ganhar (super√°vit)</option>
                          <option value="recomp">Recomposi√ß√£o</option>
                        </select>
                      </label>
                    </div>

                    <div className="mt-4 grid grid-cols-2 gap-3 text-sm">
                      <div className="p-3 rounded bg-slate-900 border border-slate-700">
                        <div className="text-slate-400">TDEE alvo</div>
                        <div className="text-xl font-semibold text-emerald-400">{round(targetCalories)}</div>
                        <div className="text-slate-500 text-xs">kcal/dia</div>
                      </div>
                      <div className="p-3 rounded bg-slate-900 border border-slate-700">
                        <div className="text-slate-400">Macros alvo</div>
                        <div className="text-sm text-slate-300">P {macroTargets.protein} ‚Ä¢ C {macroTargets.carbs} ‚Ä¢ G {macroTargets.fats}</div>
                      </div>
                    </div>

                    <div className="mt-4 p-4 rounded-xl bg-slate-900 border border-slate-700">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-slate-300 font-semibold">Composi√ß√£o Corporal (US Navy)</span>
                        <span className="text-xs text-slate-500">auto ‚Ä¢ {isMetric?'cm':'in'}</span>
                      </div>
                      {body.bf == null ? (
                        <div className="text-xs text-slate-500">Preencha altura, pesco√ßo, cintura {profile.sex==='F' ? 'e quadril ' : ''}para estimar a % de gordura.</div>
                      ) : (
                        <div className="grid grid-cols-3 gap-3 text-center">
                          <div className="p-3 rounded bg-slate-800 border border-slate-700">
                            <div className="text-slate-400 text-xs">% Gordura</div>
                            <div className="text-2xl font-bold text-amber-300">{body.bf}%</div>
                          </div>
                          <div className="p-3 rounded bg-slate-800 border border-slate-700">
                            <div className="text-slate-400 text-xs">Massa Magra</div>
                            <div className="text-xl font-semibold">{body.lm} kg</div>
                          </div>
                          <div className="p-3 rounded bg-slate-800 border border-slate-700">
                            <div className="text-slate-400 text-xs">Massa Gorda</div>
                            <div className="text-xl font-semibold">{body.fm} kg</div>
                          </div>
                        </div>
                      )}
                    </div>
                  </>
                )}
              </Section>

              <Section title="Metas de Macros" right={<MinBtn on={minMacros} toggle={()=> setMinMacros(v=>!v)}/>}>
                {!minMacros && (
                  <>
                    <Stat label="Calorias" value={totals.kcal} unit=" kcal" target={targetCalories}/>
                    <Stat label="Prote√≠nas" value={totals.protein} unit=" g" target={macroTargets.protein}/>
                    <Stat label="Carboidratos" value={totals.carbs} unit=" g" target={macroTargets.carbs}/>
                    <Stat label="Gorduras" value={totals.fats} unit=" g" target={macroTargets.fats}/>
                  </>
                )}
              </Section>
            </div>

            {/* COLUNA BIBLIOTECA + DIA */}
            <div className="lg:col-span-2 flex flex-col gap-6">
              
              {/* üü¢ NOVO FORMUL√ÅRIO DE ADI√á√ÉO (v6.2) */}
              <AddMealForm refreshLibrary={refreshLibrary} session={session} />

              {/* BIBLIOTECA E MEU DIA (Organizados em duas colunas) */}
              <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">

                {/* BIBLIOTECA */}
                <Section
                  title="Biblioteca de Refei√ß√µes"
                  right={
                    <div className="flex items-center gap-2 flex-wrap justify-end">
                      <input value={search} onChange={(e)=> setSearch(e.target.value)} placeholder="Buscar..."
                            className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm w-40"/>
                      <label className="text-xs flex items-center gap-1 text-slate-400">
                        <input type="checkbox" checked={searchInIngredients} onChange={e=> setSearchInIngredients(e.target.checked)} />
                        buscar em ingredientes
                      </label>
                      <select value={selectedBlock} onChange={(e)=> setSelectedBlock(e.target.value)}
                              className="bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm">
                        <option value="all">Todos</option>
                        <option value="250">250</option>
                        <option value="350">350</option>
                        <option value="500">500</option>
                        <option value="750">750</option>
                      </select>
                      <select value={orderBy} onChange={(e)=> setOrderBy(e.target.value)}
                              className="bg-slate-900 border border-slate-600 rounded px-2 py-2 text-sm">
                        <option value="relevance">Relev√¢ncia</option>
                        <option value="kcal-asc">kcal ‚Üë</option>
                        <option value="kcal-desc">kcal ‚Üì</option>
                        <option value="protein">Prote√≠na ‚Üì</option>
                        <option value="most-used">Mais usadas</option>
                      </select>
                      <label className="text-xs flex items-center gap-1 text-slate-400">
                        <input type="checkbox" checked={onlyFavs} onChange={e=> setOnlyFavs(e.target.checked)} />
                        favoritos
                      </label>
                      <button onClick={refreshLibrary}
                              className="text-xs px-2 py-1 rounded border border-slate-600 hover:bg-slate-700/40">Atualizar</button>
                      <MinBtn on={minLib} toggle={()=> setMinLib(v=>!v)}/>
                    </div>
                  }>
                  {!minLib && (
                    <div id="biblioteca" className="grid md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto pr-2">
                      {LIB_WITH_TOTALS.map(m => (
                        <div key={m.id} className="rounded-xl border border-slate-700 bg-slate-900 p-4 card-compact">
                          <div className="flex items-start justify-between gap-3">
                            <div className="min-w-0">
                              <div className="font-semibold text-slate-100 truncate flex items-center gap-2">
                                <button onClick={()=> toggleFavorite(m.id)} title={favorites.has(m.id)?'Remover dos favoritos':'Favoritar'} className="text-amber-300">
                                  {favorites.has(m.id) ? '‚≠ê' : '‚òÜ'}
                                </button>
                                <span className="truncate">{m.name}</span>
                              </div>
                              <div className="text-sm text-slate-400">
                                {round(m.kcal)} kcal ‚Ä¢ P {round(m.protein)}g ‚Ä¢ C {round(m.carbs)}g ‚Ä¢ G {round(m.fats)}g
                              </div>
                            </div>
                            <span className="text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-300 border border-amber-500/40 whitespace-nowrap">{m.block} kcal</span>
                          </div>
                          <div className="mt-2 meal-tags flex flex-wrap gap-2">
                            {(m.tags||[]).map(t => (
                              <span key={t} className="text-[11px] px-2 py-0.5 rounded-full bg-slate-800 border border-slate-600 text-slate-300">{t}</span>
                            ))}
                          </div>
                          <div className="mt-3 flex flex-wrap gap-2 justify-end">
                            {/* Adi√ß√£o do bot√£o Excluir (Passo 2B) */}
                            {session?.user?.id && m.created_by === session.user.id && (
                                <button
                                  onClick={() => deleteMealFromDB(m.id).then(r => r.ok && refreshLibrary())}
                                  className="px-2 py-1 text-xs rounded-md border border-red-500/40 text-red-400 hover:bg-red-500/10"
                                  title="Excluir definitivamente (somente suas pr√≥prias refei√ß√µes)"
                                >
                                  üóëÔ∏è Excluir
                                </button>
                              )}
                            {slotKeys.map(k => (
                              <button key={k} onClick={()=> addTo(k, m)}
                                      className="text-xs px-2 py-1 rounded border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10">
                                + {`Refei√ß√£o ${slotKeys.indexOf(k)+1}`}
                              </button>
                            ))}
                          </div>
                        </div>
                      ))}
                      {LIB_WITH_TOTALS.length===0 && (
                        <div className="text-slate-400 text-sm md:col-span-2 p-4 border border-dashed border-slate-700 rounded-xl text-center">
                          Nenhuma refei√ß√£o encontrada. Ajuste filtros/busca ou adicione dados ao Supabase.
                        </div>
                      )}
                    </div>
                  )}
                </Section>

                {/* MEU DIA */}
                <Section
                  title="Meu Dia"
                  right={
                    <div className="flex gap-2 flex-wrap justify-end">
                      <select value={currentDayId} onChange={(e)=> setCurrentDayId(e.target.value)}
                              className="bg-slate-900 border border-blue-600 rounded px-3 py-1 text-sm text-blue-300 font-semibold">
                        {dayOptions.map(id => <option key={id} value={id}>{getDayLabel(id)}</option>)}
                      </select>
                      <button onClick={duplicateCurrentDay} className="text-sm px-3 py-1 rounded border border-purple-500 text-purple-300 hover:bg-purple-900/40">Duplicar</button>
                      <button onClick={resetDay} className="text-sm px-3 py-1 rounded border border-slate-600 text-slate-400 hover:bg-red-900/40">Resetar</button>
                      <button onClick={exportDay} className="text-sm px-3 py-1 rounded border border-slate-600 text-slate-300 hover:bg-slate-700/40">Exportar Dia</button>
                      <input ref={importInputRef} type="file" accept="application/json" className="hidden" onChange={(e)=> e.target.files[0] && importDay(e.target.files[0])}/>
                      <button onClick={()=> importInputRef.current?.click()} className="text-sm px-3 py-1 rounded border border-slate-600 text-slate-300 hover:bg-slate-700/40">Importar Dia</button>
                      <button onClick={addSlot} disabled={slotKeys.length>=8}
                              className={`text-sm px-3 py-1 rounded border ${slotKeys.length>=8?'border-slate-700 text-slate-600 cursor-not-allowed':'border-blue-500 text-blue-300 hover:bg-blue-500/10'}`}>
                        + Refei√ß√£o
                      </button>
                      <MinBtn on={minDay} toggle={()=> setMinDay(v=>!v)}/>
                    </div>
                  }>
                  {!minDay && (
                    <>
                      <div className="mb-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div className="p-4 rounded-xl bg-slate-900 border border-slate-700">
                          <div className="flex items-center justify-between">
                            <div className="text-slate-300 font-semibold">√Ågua</div>
                            <div className="text-xs text-slate-400">{round(water)} / {WATER_GOAL} ml</div>
                          </div>
                          <div className="mt-2 h-3 bg-slate-800 rounded overflow-hidden">
                            <div style={{ width: `${waterPct}%` }} className="h-3 bg-emerald-500"></div>
                          </div>
                          <div className="mt-3 flex gap-2 flex-wrap">
                            <button onClick={()=> addWater(250)} className="text-xs px-2 py-1 rounded border border-emerald-600 text-emerald-300 hover:bg-emerald-900/20">+250</button>
                            <button onClick={()=> addWater(500)} className="text-xs px-2 py-1 rounded border border-emerald-600 text-emerald-300 hover:bg-emerald-900/20">+500</button>
                            <button onClick={()=> addWater(750)} className="text-xs px-2 py-1 rounded border border-emerald-600 text-emerald-300 hover:bg-emerald-900/20">+750</button>
                            <input type="number" value={water} onChange={(e)=> setWater(e.target.value)} className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs w-24 ml-auto"/>
                            <button onClick={()=> setWater(0)} className="text-xs px-2 py-1 rounded border border-slate-600 text-slate-300 hover:bg-slate-700/40">Reset</button>
                          </div>
                        </div>
                        <div className="p-4 rounded-xl bg-slate-900 border border-slate-700">
                          <div className="flex items-center justify-between">
                            <div className="text-slate-300 font-semibold">Sono (noite anterior)</div>
                            <div className="text-xs text-slate-400">{round(sleep,1)} / {SLEEP_GOAL} h</div>
                          </div>
                          <div className="mt-2 h-3 bg-slate-800 rounded overflow-hidden">
                            <div style={{ width: `${sleepPct}%` }} className="h-3 bg-indigo-500"></div>
                          </div>
                          <div className="mt-3 flex gap-2 flex-wrap items-center">
                            <button onClick={()=> setSleep(Math.min(12, sleep + 0.5))} className="text-xs px-2 py-1 rounded border border-indigo-600 text-indigo-300 hover:bg-indigo-900/20">+0,5h</button>
                            <button onClick={()=> setSleep(Math.max(0, sleep - 0.5))} className="text-xs px-2 py-1 rounded border border-indigo-600 text-indigo-300 hover:bg-indigo-900/20">-0,5h</button>
                            <input type="number" step="0.5" min="0" max="12" value={sleep} onChange={(e)=> setSleep(e.target.value)} className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs w-24 ml-auto"/>
                            <button onClick={()=> setSleep(0)} className="text-xs px-2 py-1 rounded border border-slate-600 text-slate-300 hover:bg-slate-700/40">Reset</button>
                          </div>
                        </div>
                      </div>

                      <div id="meu-dia" className="grid md:grid-cols-1 gap-4 max-h-[500px] overflow-y-auto pr-2">
                        {slotKeys.map(key => (
                          <div key={key} className="rounded-xl border border-slate-700 bg-slate-900 p-4 card-compact">
                            <div className="flex justify-between items-center mb-2">
                              <div className="font-semibold text-slate-100 flex items-center gap-3">
                                <span>{getSlotLabel(key)}</span>
                                <span className="text-[11px] text-slate-300 border border-slate-600 rounded px-2 py-0.5">
                                  {round(slotTotals[key].kcal)} kcal ‚Ä¢ P {round(slotTotals[key].protein)} ‚Ä¢ C {round(slotTotals[key].carbs)} ‚Ä¢ G {round(slotTotals[key].fats)}
                                </span>
                              </div>
                              {slotKeys.length>1 && (
                                <button onClick={()=> removeSlot(key)} className="text-xs px-2 py-1 rounded border border-red-700 text-red-500 hover:bg-red-900/20">Remover Slot</button>
                              )}
                            </div>

                            {(!day[key] || day[key].length===0) ? (
                              <div className="text-slate-500 text-sm p-4 border border-dashed border-slate-700 rounded-lg text-center">Vazio ‚Äî adicione refei√ß√µes da biblioteca.</div>
                            ) : (
                              <ul className="space-y-3">
                                {day[key].map((meal, i) => (
                                  <MealItem key={`${key}-${i}`} slotKey={key} index={i} meal={meal} slotKeys={slotKeys} round={round} resetMealIngredients={resetMealIngredients} duplicateMealTo={duplicateMealTo} toggleLock={toggleLock} removeMeal={removeMeal} updateIngredientPortion={updateIngredientPortion} toggleIngredientIncluded={toggleIngredientIncluded} removeIngredient={removeIngredient} addQuickIngredient={addQuickIngredient} getSlotLabel={getSlotLabel}/>
                                ))}
                              </ul>
                            )}
                          </div>
                        ))}
                      </div>

                      <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 border-t border-slate-700 pt-4">
                        <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Calorias</div><div className="text-xl font-bold">{round(totals.kcal)}</div></div>
                        <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Prote√≠nas</div><div className="text-xl font-bold">{round(totals.protein)} g</div></div>
                        <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Carboidratos</div><div className="text-xl font-bold">{round(totals.carbs)} g</div></div>
                        <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Gorduras</div><div className="text-xl font-bold">{round(totals.fats)} g</div></div>
                      </div>
                    </>
                  )}
                </Section>
              </div>
            </div>
          </main>

          <footer className="max-w-7xl mx-auto px-6 py-10 text-center text-xs text-slate-500">
            v6.2 ‚Äî Biblioteca agora totalmente din√¢mica (Supabase) com formul√°rio de inser√ß√£o e exclus√£o de novos itens.
          </footer>
        </div>
      );
    }

    // ===== Componentes auxiliares (Mantidos inalterados) =====
    const MinBtn = ({ on, toggle }) => (
      <button onClick={toggle} className="text-slate-400 hover:text-slate-200 p-1 rounded bg-slate-700/50 hover:bg-slate-700">
        <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          {on ? <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"/> :
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7"/>}
        </svg>
      </button>
    );
    const Section = ({ title, right, children }) => (
      <div className="bg-slate-800/70 rounded-2xl p-5 shadow border border-slate-700/50">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-slate-100 text-lg font-semibold">{title}</h2>
          {right}
        </div>
        {children}
      </div>
    );
    const Stat = ({ label, value, unit="", target }) => {
      const pct = Math.min(100, Math.max(0, (value / (target || 1)) * 100));
      const ok = target ? value <= target * 1.05 : true;
      return (
        <div className="mb-3">
          <div className="flex justify-between text-sm text-slate-300">
            <span>{label}</span>
            <span><strong className={ok?"text-green-400":"text-red-400"}>{round(value)}{unit}</strong>{target && <span className="text-slate-400"> / {round(target)}{unit}</span>}</span>
          </div>
          <div className="h-2 bg-slate-700 rounded">
            <div style={{ width: `${pct}%` }} className={`h-2 rounded ${ok?"bg-green-500":"bg-red-500"}`}/>
          </div>
        </div>
      );
    };

    function MealItem({
      slotKey, index, meal, slotKeys, round,
      resetMealIngredients, duplicateMealTo, toggleLock, removeMeal,
      updateIngredientPortion, toggleIngredientIncluded, removeIngredient, addQuickIngredient,
      getSlotLabel
    }) {
      const menuRef = React.useRef(null);
      const [openMenu, setOpenMenu] = React.useState(false);

      React.useEffect(() => {
        const onDoc = (ev) => { if (!menuRef.current?.contains(ev.target)) setOpenMenu(false); };
        document.addEventListener('click', onDoc);
        return () => document.removeEventListener('click', onDoc);
      }, []);

      const otherSlots = slotKeys.filter(sk => sk !== slotKey);

      return (
        <li className={`p-3 border rounded-xl ${meal.isLocked?'border-emerald-500/50 bg-emerald-900/10':'border-slate-700 bg-slate-900/50'}`}>
          <div className="flex justify-between items-start mb-3">
            <div className="text-base text-emerald-400 font-bold flex items-center gap-2">
              {meal.name}
              {meal.isLocked && (
                <svg className="w-4 h-4 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path>
                </svg>
              )}
            </div>
            <div className="flex gap-2 items-center">
              <button onClick={()=> resetMealIngredients(slotKey,index)}
                      className="text-xs px-2 py-0.5 rounded border border-slate-600 text-slate-300 hover:bg-slate-700/40">
                Resetar ingredientes
              </button>
              <div ref={menuRef} className={`menu ${openMenu ? 'open' : ''}`}>
                <button onClick={()=> setOpenMenu(v=>!v)} className="text-xs px-2 py-0.5 rounded border border-slate-600 text-slate-300 hover:bg-slate-700/40">‚ãØ</button>
                <div className="menu-content rounded">
                  {otherSlots.map(tk => (
                    <div key={tk} className="menu-item" onClick={()=> { duplicateMealTo(slotKey,index,tk); setOpenMenu(false); }}>
                      Duplicar para {getSlotLabel(tk)}
                    </div>
                  ))}
                </div>
              </div>
              <button onClick={()=> toggleLock(slotKey, index)}
                      className={`text-xs px-2 py-0.5 rounded border ${meal.isLocked?'border-red-500 text-red-300 bg-red-900/20':'border-emerald-500 text-emerald-300 bg-emerald-900/20'}`}>
                {meal.isLocked?'Editar':'Feita'}
              </button>
              <button onClick={()=> removeMeal(slotKey, index)} className="text-xs px-2 py-0.5 rounded border border-slate-600 text-slate-400 hover:bg-red-500/10">
                Remover
              </button>
            </div>
          </div>

          <p className="text-xs text-slate-400 mb-2 font-medium">Ingredientes:</p>
          <ul className="space-y-2">
            {(meal.ingredients||[]).map((ing, j) => {
              const p=+ing.protein||0, c=+ing.carbs||0, f=+ing.fats||0;
              const base=+ing.baseKcal || (p*4+c*4+f*9);
              const por=+ing.portion||1;
              const kcal = base*por;
              const disabled = meal.isLocked;
              const included = ing.included !== false;
              return (
                <li key={j} className={`flex flex-wrap md:flex-nowrap gap-2 justify-between items-center text-xs pl-3 py-1 border-l-2 ${included?'border-emerald-500/60':'border-slate-700 bg-slate-800/40 line-through opacity-70'}`}>
                  <div className="text-slate-300 flex-1 min-w-0 truncate">
                    {ing.name} (<strong className="text-slate-200">{round(kcal)} kcal</strong>)
                  </div>
                  <div className="flex items-center gap-2">
                    <select
                      value={ing.portion} disabled={disabled}
                      onChange={(e)=> updateIngredientPortion(slotKey, index, j, e.target.value)}
                      className={`bg-slate-700 border rounded px-1 py-0.5 text-xs w-20 ${disabled?'opacity-50 cursor-not-allowed border-slate-700':'border-slate-600'}`}>
                      {[0.5,1,1.5,2,3].map(v => <option key={v} value={v}>{v}x</option>)}
                    </select>
                    <button
                      onClick={()=> toggleIngredientIncluded(slotKey, index, j)} disabled={disabled}
                      className={`text-xs px-2 py-0.5 rounded border ${included?'border-yellow-600 text-yellow-300 hover:bg-yellow-900/20':'border-emerald-600 text-emerald-300 hover:bg-emerald-900/20'}`}>
                      {included?'Excluir':'Incluir'}
                    </button>
                    <button
                      onClick={()=> removeIngredient(slotKey, index, j)} disabled={disabled}
                      className={`text-xs p-1 rounded ${disabled?'text-slate-600 cursor-not-allowed':'text-red-400 hover:text-red-300 hover:bg-red-900/20'}`} title="Remover ingrediente">
                      <svg className="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd"/></svg>
                    </button>
                  </div>
                </li>
              );
            })}
          </ul>

          <QuickAdd onAdd={(ing)=> addQuickIngredient(slotKey, index, ing)} disabled={meal.isLocked} />
        </li>
      );
    }

    function QuickAdd({ onAdd, disabled }) {
      const [name, setName] = useState("");
      const [kcal, setKcal] = useState("");
      const [p, setP] = useState("");
      const [c, setC] = useState("");
      const [f, setF] = useState("");
      const [portion, setPortion] = useState("1");

      const submit = () => {
        if (!name.trim()) return alert('Informe o nome.');
        const kcalN = +kcal;
        const hasMacros = p || c || f;
        const baseKcal = hasMacros ? ( (+p||0)*4 + (+c||0)*4 + (+f||0)*9 ) : (Number.isFinite(kcalN)? kcalN : 0);
        const ing = {
          name: name.trim(), baseKcal: baseKcal, protein: +p || 0, carbs: +c || 0, fats: +f || 0, portion: +portion || 1
        };
        onAdd(ing);
        setName(""); setKcal(""); setP(""); setC(""); setF(""); setPortion("1");
      };

      return (
        <div className="mt-3 p-3 rounded-lg border border-slate-700 bg-slate-900/60">
          <div className="text-xs text-slate-400 mb-2 font-medium">+ Ingrediente r√°pido</div>
          <div className="grid grid-cols-2 md:grid-cols-6 gap-2">
            <input value={name} onChange={e=>setName(e.target.value)} placeholder="Nome"
                   className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs md:col-span-2"/>
            <input value={kcal} onChange={e=>setKcal(e.target.value)} placeholder="kcal (se n√£o P/C/G)"
                   className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs"/>
            <input value={p} onChange={e=>setP(e.target.value)} placeholder="P"
                   className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs"/>
            <input value={c} onChange={e=>setC(e.target.value)} placeholder="C"
                   className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs"/>
            <input value={f} onChange={e=>setF(e.target.value)} placeholder="G"
                   className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs"/>
            <select value={portion} onChange={e=>setPortion(e.target.value)}
                    className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs">
              {[0.5,1,1.5,2,3].map(v => <option key={v} value={v}>{v}x</option>)}
            </select>
            <button onClick={submit} disabled={disabled}
                    className={`text-xs px-2 py-1 rounded border ${disabled?'border-slate-700 text-slate-600':'border-emerald-500 text-emerald-300 hover:bg-emerald-500/10'}`}>
              Adicionar
            </button>
          </div>
        </div>
      );
    }
    
    // ===================================================================
    // üü¢ NOVO COMPONENTE: FORMUL√ÅRIO DE ADI√á√ÉO DE REFEI√á√ÉO (v6.2)
    // ===================================================================

    function AddMealForm({ refreshLibrary, session }) {
        const [name, setName] = useState('');
        const [kcal, setKcal] = useState('');
        const [protein, setProtein] = useState('');
        const [carbs, setCarbs] = useState('');
        const [fats, setFats] = useState('');
        const [block, setBlock] = useState('500'); 
        const [tags, setTags] = useState(''); 
        const [loading, setLoading] = useState(false);

        const isFormValid = name.trim() && (kcal || (protein || carbs || fats));

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!isFormValid) return alert('Preencha o nome e o total de Kcal, ou os macros (P/C/G).');
            
            // ‚ö†Ô∏è ATEN√á√ÉO: Habilitar INSERT RLS √© necess√°rio para o usu√°rio an√¥nimo.
            if (!session?.user?.id) {
               alert('Aviso: Voc√™ precisa habilitar a pol√≠tica de INSERT RLS para usu√°rios AN√îNIMOS ou fazer login.');
            }

            setLoading(true);
            const result = await addMealToDB({ name, kcal, protein, carbs, fats, block, tags });
            setLoading(false);

            if (result.success) {
                alert(`Refei√ß√£o "${result.item.name}" adicionada ao Supabase!`);
                setName(''); setKcal(''); setProtein(''); setCarbs(''); setFats(''); setTags('');
                // Atualiza a biblioteca para mostrar o novo item
                refreshLibrary(); 
            } else {
                alert(`Falha ao adicionar: ${result.error}. Verifique o console. Voc√™ ativou a pol√≠tica RLS 'Allow authenticated insert' para a tabela?`);
            }
        };

        return (
            <Section title="Adicionar Nova Refei√ß√£o" right={loading && <span className="text-sm text-slate-400">Salvando...</span>}>
                <form onSubmit={handleSubmit} className="flex flex-col gap-3 text-sm">
                    <input value={name} onChange={e => setName(e.target.value)} placeholder="Nome da Refei√ß√£o (Obrigat√≥rio)"
                           className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-slate-200"/>
                    
                    <div className="grid grid-cols-2 gap-3">
                        <input type="number" value={kcal} onChange={e => setKcal(e.target.value)} placeholder="Kcal Total (Opcional se macros preenchidos)"
                               className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"/>
                        <select value={block} onChange={e => setBlock(e.target.value)} className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm">
                            <option value="250">Bloco 250 kcal</option>
                            <option value="350">Bloco 350 kcal</option>
                            <option value="500">Bloco 500 kcal</option>
                            <option value="750">Bloco 750 kcal</option>
                        </select>
                    </div>
                    
                    <div className="grid grid-cols-3 gap-3">
                        <input type="number" value={protein} onChange={e => setProtein(e.target.value)} placeholder="Prote√≠na (g)"
                               className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"/>
                        <input type="number" value={carbs} onChange={e => setCarbs(e.target.value)} placeholder="Carboidratos (g)"
                               className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"/>
                        <input type="number" value={fats} onChange={e => setFats(e.target.value)} placeholder="Gorduras (g)"
                               className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"/>
                    </div>

                    <input value={tags} onChange={e => setTags(e.target.value)} placeholder="Tags (Separe por v√≠rgula. Ex: High Protein, BR)"
                           className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm"/>
                    
                    <button type="submit" disabled={loading || !isFormValid}
                            className={`px-4 py-2 rounded font-semibold text-white ${loading || !isFormValid ? 'bg-slate-600 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-700'}`}>
                        {loading ? 'Adicionando ao Banco...' : 'Adicionar √† Biblioteca (Supabase)'}
                    </button>
                </form>
            </Section>
        );
    }


    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>


