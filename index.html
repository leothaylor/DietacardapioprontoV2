<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cardápio Inteligente (v5.7)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    html, body, #root { min-height: 100vh; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial; }
  </style>
</head>
<body class="bg-[#0a0a1a] text-slate-200">
  <div id="root"></div>
  <script>
  // Overlay simples para mostrar erros na página (em vez de tela vazia)
  (function () {
    function show(msg) {
      var d = document.createElement('div');
      d.style.cssText = 'position:fixed;inset:0;background:#0a0a1a;color:#ffb4b4;padding:16px;font:14px/1.4 system-ui;z-index:99999;overflow:auto';
      d.innerHTML = '<h2 style="color:#ff7070;margin:0 0 8px">Erro ao iniciar o app</h2><pre style="white-space:pre-wrap">'+msg+'</pre>';
      document.body.appendChild(d);
    }
    window.addEventListener('error', e => show('[global] ' + e.message + ' @ ' + (e.filename||'') + ':' + e.lineno));
    window.addEventListener('unhandledrejection', e => show('[promise] ' + (e.reason && (e.reason.stack||e.reason.message||e.reason) )));
  })();
</script>
  <script type="text/babel">
    /**************
     * SEGURANÇA
     **************/
    window.addEventListener('error', e => {
      console.error('[global error]', e.message, e.filename, e.lineno+':'+e.colno);
    });
    window.addEventListener('unhandledrejection', e => {
      console.error('[promise]', e.reason);
    });

    const { useMemo, useState, useEffect } = React;

    /**********************
     * CONSTANTES/UTILS
     **********************/
    const APP_VERSION = "2.0.0"; // troque ao alterar o JSON
    const KCAL_PER_G = { protein: 4, carbs: 4, fats: 9 };

    const round = (n, d=0) => {
      const p = Math.pow(10, d); return Math.round(n*p)/p;
    };

    // Inputs permitidos (perfil)
    const INPUT_RANGES = {
      age: { min: 10, max: 120, step: 1 },
      weight: { min: 30, max: 300, step: 0.5 },
      height: { min: 100, max: 250, step: 1 },
      neck: { min: 20, max: 60, step: 0.5 },
      waist:{ min: 40, max: 150, step: 0.5 },
      hip:  { min: 50, max: 150, step: 0.5 },
    };
    function normalizeAndValidateInput(key, value){
      const r = INPUT_RANGES[key];
      let v = Number(value);
      if (Number.isNaN(v) || value === null) v = 0;
      if (r){
        if (v !== 0 && v < r.min) return r.min;
        if (v > r.max) return r.max;
      }
      return v;
    }

    // Storage
    const PROFILE_STORAGE_KEY = "cardapio_profile_v5_3";
    const ALL_DAYS_STORAGE_KEY = "cardapio_all_days_v5_7";
    const SLOTS_STORAGE_KEY = "cardapio_slotkeys_v5_7";
    const CURRENT_DAY_ID_STORAGE_KEY = "cardapio_current_day_id_v5_7";
    const INITIAL_DAY_ID = 'day-1';

    const loadState = (key, def) => {
      try{
        const raw = localStorage.getItem(key);
        if (!raw || raw==="undefined") return def;
        const val = JSON.parse(raw);
        if (key===PROFILE_STORAGE_KEY){
          const validated = {...val}; let needsFix = false;
          Object.keys(INPUT_RANGES).forEach(k=>{
            const r=INPUT_RANGES[k]; const num = Number(val[k]);
            if (Number.isNaN(num) || num < r.min || num > r.max){
              validated[k] = DEFAULT_PROFILE[k]; needsFix = true;
            }
          });
          if (!['M','F'].includes(val.sex)){ validated.sex = DEFAULT_PROFILE.sex; needsFix = true; }
          if (!['loss','maintain','gain','recomp'].includes(val.goal)){ validated.goal=DEFAULT_PROFILE.goal; needsFix=true; }
          if (needsFix) console.warn('Perfil: corrigi campos inválidos do storage.');
          return validated;
        }
        return val;
      }catch(e){
        console.error('loadState', key, e); return def;
      }
    };
    const saveState = (key, state) => {
      try{ localStorage.setItem(key, JSON.stringify(state)); }
      catch(e){ console.error('saveState', key, e); }
    };

    /**********************
     * CÁLCULOS
     **********************/
    function calcBMR({sex,weight,height,age}){ const s = sex==='F' ? -161 : 5; return 10*weight + 6.25*height - 5*age + s; }
    function calcTDEE(bmr, activity){
      const f = { sedentary:1.2, light:1.375, moderate:1.55, active:1.725, very:1.9 };
      return bmr*(f[activity]||1.55);
    }
    function adjustForGoal(tdee, goal){
      if (goal==='loss') return tdee*0.85;
      if (goal==='gain') return tdee*1.10;
      if (goal==='recomp') return tdee*0.95;
      return tdee;
    }
    function deriveMacroTargets({weight, calories}){
      const pG = 1.8*weight, fG = 0.8*weight;
      const kcalP = pG*KCAL_PER_G.protein, kcalF = fG*KCAL_PER_G.fats;
      const kcalC = Math.max(0, calories - kcalP - kcalF);
      const cG = kcalC / KCAL_PER_G.carbs;
      return { protein: round(pG), fats: round(fG), carbs: round(cG) };
    }
    function calcBF({sex,height,neck,waist,hip}){
      const INCH=0.393701, h=height*INCH, n=neck*INCH, w=waist*INCH, hp=(hip||0)*INCH;
      if (h<=0 || n<=0 || w<=0) return null;
      try{
        if (sex==='M'){
          const f = w-n; if (f<=0) return null;
          return Math.max(3, 86.010*Math.log10(f) - 70.041*Math.log10(h) + 36.76);
        }else{
          if (hp<=0) return null;
          const f = w+hp-n; if (f<=0) return null;
          return Math.max(8, 163.205*Math.log10(f) - 97.684*Math.log10(h) - 78.387);
        }
      }catch{ return null; }
    }
    function calculateMealMacros(entry){
      const p = entry.protein||0, c=entry.carbs||0, f=entry.fats||0;
      const base = entry.baseKcal ?? (p*4 + c*4 + f*9);
      const portion = entry.portion || 1;
      return { kcal: base*portion, protein:p*portion, carbs:c*portion, fats:f*portion };
    }

    /**********************
     * JSON EXTERNO (SEGURO)
     **********************/
    // Fallback mínimo — usado se JSON falhar (mantém app visível)
    const MEALS_FALLBACK = [
      { id:"whey_agua", name:"Whey Isolado (Água)", block:"250", tags:["High Protein","Low Carb","Quick"],
        ingredients:[{name:"Whey (1 scoop)", protein:25, carbs:5, fats:4, baseKcal:155}] },
      { id:"frango_arroz_feijao_padrao", name:"Frango, Arroz, Feijão (Almoço Padrão)", block:"500", tags:["Balanced","High Protein","BR"],
        ingredients:[
          {name:"Arroz Integral (100g)", protein:2, carbs:28, fats:1, baseKcal:130},
          {name:"Feijão (100g)", protein:5, carbs:15, fats:1, baseKcal:100},
          {name:"Peito de Frango (120g cru)", protein:34, carbs:0, fats:5, baseKcal:180}
        ]},
    ];
    const TAGS = ["High Protein","Low Carb","High Carb","Plant-Based","Balanced","High Fat Saudável","Low Protein","High Fat","Post-Workout","Quick","Bulk","BR"];
    const PORTION_OPTIONS = [0.5,1,1.5,2];

    function validateMenu(data){
      if (!data || typeof data!=='object') throw new Error('JSON inválido (objeto ausente)');
      if (!Array.isArray(data.itens)) throw new Error('"itens" deve ser array');
      for (const it of data.itens){
        if (!it.id || !it.nome) throw new Error('Item sem id/nome');
        if (typeof it.kcal!=='number' && (!it.protein && !it.carbs && !it.fats))
          throw new Error('Kcal numérico ou macros necessários');
      }
      return data;
    }
    async function fetchMenu(){
      const res = await fetch(`./alimentos.json?v=${APP_VERSION}`, { cache:'no-store' });
      if (!res.ok) throw new Error(`alimentos.json ${res.status}`);
      const data = await res.json();
      return validateMenu(data);
    }
    // Converte o JSON externo para o formato de "refeições" usado na UI
    function buildMealsFromJson(json){
      // cada item vira "refeição" de 1 ingrediente, tag BR por padrão se quiser
      return json.itens.map(it => ({
        id: it.id,
        name: it.nome,
        block: String(it.kcal >= 700 ? 750 : it.kcal >= 450 ? 500 : it.kcal >= 300 ? 350 : 250),
        tags: Array.isArray(it.tags) ? it.tags : ["BR"],
        ingredients: [{
          name: it.nome,
          protein: it.protein||0,
          carbs: it.carbs||0,
          fats: it.fats||0,
          baseKcal: it.kcal
        }]
      }));
    }
    function withTotals(meals){
      return meals.map(m=>{
        const t = m.ingredients.reduce((acc,ing)=>{
          const x = calculateMealMacros({...ing, portion:1});
          acc.kcal+=x.kcal; acc.protein+=x.protein; acc.carbs+=x.carbs; acc.fats+=x.fats;
          return acc;
        }, {kcal:0,protein:0,carbs:0,fats:0});
        return {...m, ...t};
      });
    }

    /**********************
     * COMPONENTES UI
     **********************/
    const MinimizeButton = ({ isMinimized, toggleMinimize }) => (
      <button onClick={toggleMinimize}
        className="text-slate-400 hover:text-slate-200 transition p-1 rounded-full bg-slate-700/50 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500"
        title={isMinimized ? "Expandir seção" : "Minimizar seção"} aria-label="Minimizar/Expandir">
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          {isMinimized
            ? <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path>
            : <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7"></path>}
        </svg>
      </button>
    );
    function Section({ title, children, right, isMinimized }){
      return (
        <div className="bg-slate-800/70 rounded-2xl p-5 shadow-lg shadow-black/20 border border-slate-700/50">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-slate-100 text-lg font-semibold tracking-tight">{title}</h2>
            {right}
          </div>
          {!isMinimized && children}
        </div>
      );
    }
    function Pill({ active, children, onClick }){
      return (
        <button onClick={onClick}
          className={`px-3 py-1 rounded-full text-sm mr-2 mb-2 border transition
            ${active ? "bg-emerald-500/20 text-emerald-300 border-emerald-400"
                     : "border-slate-600 text-slate-300 hover:bg-slate-700/40"}`}>
          {children}
        </button>
      );
    }
    function Stat({ label, value, unit="", target }){
      const pct = Math.min(100, Math.max(0, (value/(target||1))*100));
      const ok  = target ? value <= target*1.05 : true;
      return (
        <div className="mb-3">
          <div className="flex justify-between text-sm text-slate-300">
            <span>{label}</span>
            <span>
              <strong className={ok?"text-green-400":"text-red-400"}>{round(value,0)}{unit}</strong>
              {target && <span className="text-slate-400"> / {round(target,0)}{unit}</span>}
            </span>
          </div>
          <div className="h-2 bg-slate-700 rounded">
            <div style={{width:`${pct}%`}} className={`h-2 rounded transition-all ${ok?"bg-green-500":"bg-red-500"}`}/>
          </div>
        </div>
      );
    }

    /**********************
     * DEFAULTS
     **********************/
    const DEFAULT_PROFILE = {
      sex:"M", age:33, weight:73, height:170, activity:"moderate", goal:"recomp",
      neck:36, waist:85, hip:95, photoUrl:'https://placehold.co/100x100/1E293B/E2E8F0?text=Foto'
    };
    const INITIAL_SLOT_KEYS = ["slot-1","slot-2","slot-3","slot-4"];
    const getInitialDayState = keys => keys.reduce((a,k)=>({...a,[k]:[]}),{});

    /**********************
     * APP
     **********************/
    function App(){
      /* Estado de dados/persistência */
      const [profile, setProfile] = useState(()=>loadState(PROFILE_STORAGE_KEY, DEFAULT_PROFILE));
      const [slotKeys, setSlotKeys] = useState(()=>{
        const k = loadState(SLOTS_STORAGE_KEY, INITIAL_SLOT_KEYS);
        return Array.isArray(k)&&k.length?k:INITIAL_SLOT_KEYS;
      });
      const [currentDayId, setCurrentDayId] = useState(()=>loadState(CURRENT_DAY_ID_STORAGE_KEY, INITIAL_DAY_ID));
      const [allDays, setAllDays] = useState(()=>{
        const d = loadState(ALL_DAYS_STORAGE_KEY, {});
        return Object.keys(d).length===0 || !d[INITIAL_DAY_ID] ? {[INITIAL_DAY_ID]:getInitialDayState(INITIAL_SLOT_KEYS)} : d;
      });
      const day = allDays[currentDayId] || getInitialDayState(slotKeys);

      // Biblioteca (carregada do JSON com fallback)
      const [meals, setMeals] = useState(()=>withTotals(MEALS_FALLBACK));
      const [loadError, setLoadError] = useState(null);

      useEffect(()=>{
        let alive = true;
        fetchMenu()
          .then(json => { if(!alive) return; const ms = withTotals(buildMealsFromJson(json)); setMeals(ms); setLoadError(null); })
          .catch(err => { console.error('[menu]', err); if(!alive) return; setMeals(withTotals(MEALS_FALLBACK)); setLoadError(err.message); });
        return ()=>{ alive = false; };
      }, []);

      /* Persistência */
      useEffect(()=>{ saveState(PROFILE_STORAGE_KEY, profile); }, [profile]);
      useEffect(()=>{ saveState(ALL_DAYS_STORAGE_KEY, allDays); }, [allDays]);
      useEffect(()=>{ saveState(CURRENT_DAY_ID_STORAGE_KEY, currentDayId); }, [currentDayId]);
      useEffect(()=>{ saveState(SLOTS_STORAGE_KEY, slotKeys); }, [slotKeys]);

      /* UI state */
      const [isProfileLocked, setIsProfileLocked] = useState(false);
      const [isProfileMinimized, setIsProfileMinimized] = useState(false);
      const [isMacrosMinimized, setIsMacrosMinimized] = useState(false);
      const [isLibraryMinimized, setIsLibraryMinimized] = useState(false);
      const [isDayMinimized, setIsDayMinimized] = useState(false);
      const [selectedBlock, setSelectedBlock] = useState("all");
      const [activeTags, setActiveTags] = useState([]);
      const [search, setSearch] = useState("");

      /* Perfil */
      const handleProfileChange = (key,val)=>{
        if (isProfileLocked) return;
        const finalVal = ['sex','activity','goal','photoUrl'].includes(key) ? val : normalizeAndValidateInput(key,val);
        setProfile(p=>({...p,[key]:finalVal}));
      };
      const handlePhotoUpload = (e)=>{
        if (isProfileLocked) return;
        const f = e.target.files[0];
        if (f){ const url = URL.createObjectURL(f); setProfile(p=>({...p,photoUrl:url})); }
      };

      const bmr = useMemo(()=>calcBMR(profile), [profile]);
      const tdee = useMemo(()=>calcTDEE(bmr, profile.activity), [bmr, profile.activity]);
      const targetCalories = useMemo(()=>round(adjustForGoal(tdee, profile.goal)), [tdee, profile.goal]);
      const macroTargets = useMemo(()=>deriveMacroTargets({weight:profile.weight, calories:targetCalories}), [profile.weight, targetCalories]);
      const bodyFat = useMemo(()=>{ const v = calcBF(profile); return v!=null?round(v,1):null; }, [profile.sex,profile.height,profile.neck,profile.waist,profile.hip]);

      /* Biblioteca filtrada */
      const filteredMeals = useMemo(()=>{
        return meals.filter(m=>{
          const bOk = selectedBlock==="all" || m.block===selectedBlock;
          const tOk = activeTags.length===0 || activeTags.every(t=>m.tags.includes(t));
          const sOk = m.name.toLowerCase().includes(search.toLowerCase());
          return bOk && tOk && sOk;
        });
      }, [meals, selectedBlock, activeTags, search]);

      /* Totais do dia */
      const totals = useMemo(()=>{
        const all = Object.values(day).flat();
        return all.reduce((acc,mealEntry)=>{
          const tot = mealEntry.ingredients.reduce((a,ing)=>{
            const x = calculateMealMacros(ing);
            a.kcal+=x.kcal; a.protein+=x.protein; a.carbs+=x.carbs; a.fats+=x.fats; return a;
          }, {kcal:0,protein:0,carbs:0,fats:0});
          acc.kcal+=tot.kcal; acc.protein+=tot.protein; acc.carbs+=tot.carbs; acc.fats+=tot.fats; return acc;
        }, {kcal:0,protein:0,carbs:0,fats:0});
      }, [day]);

      /* Helpers de dia/slots */
      const getSlotLabel = key => {
        const i = slotKeys.indexOf(key); return i===-1 ? key : `Refeição ${i+1}`;
      };
      const updateDay = newDay => setAllDays(prev=>({...prev,[currentDayId]:newDay}));
      const addTo = (slotKey, meal)=>{
        const entry = { mealId:meal.id, name:meal.name, isLocked:false, ingredients: meal.ingredients.map(i=>({...i, portion:1})) };
        const newDay = {...day, [slotKey]: [...(day[slotKey]||[]), entry]}; updateDay(newDay);
      };
      const toggleLock = (slotKey, idx)=>{
        const newDay = {...day, [slotKey]: day[slotKey].map((e,i)=> i!==idx?e : ({...e, isLocked:!e.isLocked}))}; updateDay(newDay);
      };
      const removeIngredient = (slotKey, mIdx, iIdx)=>{
        const newDay = {...day, [slotKey]: day[slotKey].map((e,idx)=>{
          if (idx!==mIdx || e.isLocked) return e;
          const ing = e.ingredients.filter((_,k)=>k!==iIdx);
          return ing.length? {...e, ingredients:ing} : null;
        }).filter(Boolean)};
        updateDay(newDay);
      };
      const updateIngredientPortion = (slotKey,mIdx,iIdx,val)=>{
        const newDay = {...day, [slotKey]: day[slotKey].map((e,idx)=>{
          if (idx!==mIdx || e.isLocked) return e;
          return {...e, ingredients: e.ingredients.map((ing,k)=> k===iIdx? {...ing,portion:Number(val)} : ing)};
        })};
        updateDay(newDay);
      };
      const removeMeal = (slotKey, idx)=>{
        const newDay = {...day, [slotKey]: day[slotKey].filter((_,i)=>i!==idx)}; updateDay(newDay);
      };
      const addSlot = ()=>{
        if (slotKeys.length>=8) return;
        const k = `slot-${slotKeys.length+1}`;
        setSlotKeys(prev=>[...prev,k]);
        setAllDays(prev=>{
          const up = {...prev};
          Object.keys(up).forEach(id=>{ up[id] = {...up[id],[k]:[]}; });
          return up;
        });
      };
      const removeSlot = key=>{
        if (slotKeys.length<=1) return;
        setSlotKeys(prev=>prev.filter(x=>x!==key));
        setAllDays(prev=>{
          const up = {...prev};
          Object.keys(up).forEach(id=>{
            const { [key]:_, ...rest } = up[id]; up[id]=rest;
          });
          return up;
        });
      };
      const resetDay = ()=> updateDay(getInitialDayState(slotKeys));
      const duplicateCurrentDay = ()=>{
        const ids = Object.keys(allDays);
        const last = ids.reduce((mx,id)=>{ const m=id.match(/day-(\d+)/); return m?Math.max(mx,parseInt(m[1])):mx; },0);
        const newId = `day-${last+1}`;
        setAllDays(prev=>({...prev,[newId]: JSON.parse(JSON.stringify(day))}));
        setCurrentDayId(newId);
      };
      const dayOptions = Object.keys(allDays).sort((a,b)=> (parseInt(a.split('-')[1])||0) - (parseInt(b.split('-')[1])||0));
      const getDayLabel = id => `Dia ${dayOptions.indexOf(id)+1}`;

      /* UI */
      const ProfilePhotoUploader = ({ photoUrl, handleUpload, isDisabled }) => (
        <div className={`flex flex-col items-center mb-4 ${isDisabled ? 'opacity-50' : ''}`}>
          <label htmlFor="profile-photo-upload" className={isDisabled ? '' : 'cursor-pointer'}>
            <img src={photoUrl} alt="Foto" className={`w-24 h-24 rounded-full object-cover border-4 border-slate-600 ${isDisabled?'':'hover:border-emerald-500'}`}
                 onError={e=>e.target.src=DEFAULT_PROFILE.photoUrl}/>
            <input id="profile-photo-upload" type="file" accept="image/*" onChange={handleUpload} className="hidden" disabled={isDisabled}/>
          </label>
          <p className="text-xs text-slate-400 mt-2">{isDisabled?'Informações fixadas':'Clique para alterar foto'}</p>
        </div>
      );

      /* Cálculos do perfil */
      const stats = (
        <>
          <div className="p-3 rounded bg-slate-900 border border-slate-700">
            <div className="text-slate-400">TDEE alvo</div>
            <div className="text-xl font-semibold text-emerald-400">{round(targetCalories)}</div>
            <div className="text-slate-500 text-xs">kcal/dia</div>
          </div>
          <div className="p-3 rounded bg-slate-900 border border-slate-700">
            <div className="text-slate-400">% Gordura Est.</div>
            <div className={`text-xl font-semibold ${bodyFat!=null?'text-white':'text-yellow-500'}`}>
              {bodyFat!=null?`${bodyFat}%`:'Dados Incompletos'}
            </div>
            <div className="text-slate-500 text-xs">Fórmula Marinha EUA</div>
          </div>
        </>
      );

      return (
        <div className="min-h-screen">
          <header className="px-6 py-5 border-b border-slate-700/60 sticky top-0 bg-[#0a0a1a]/90 backdrop-blur z-20">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold tracking-tight text-white">Cardápio Inteligente</h1>
                <p className="text-sm text-slate-400">Monte o dia com porções ajustáveis e metas calculadas (v5.7)</p>
              </div>
              <div className="hidden md:flex items-center gap-3">
                <a href="#biblioteca" className="text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40">Biblioteca</a>
                <a href="#meu-dia" className="text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40">Meu Dia</a>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Coluna 1 */}
            <div className="lg:col-span-1 flex flex-col gap-6">
              {/* Perfil */}
              <div className="bg-slate-800/70 rounded-2xl p-5 shadow-lg border border-slate-700/50">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-slate-100 text-lg font-semibold">Seu Perfil</h2>
                  <div className="flex gap-2 items-center">
                    <button onClick={()=>setIsProfileLocked(p=>!p)}
                      className={`text-xs px-2 py-0.5 rounded border font-semibold
                       ${isProfileLocked?'border-red-500 text-red-300 bg-red-900/20':'border-emerald-500 text-emerald-300 bg-emerald-900/20'}`}>
                      {isProfileLocked?'Editar':'Trancar Perfil'}
                    </button>
                    <MinimizeButton isMinimized={isProfileMinimized} toggleMinimize={()=>setIsProfileMinimized(p=>!p)}/>
                  </div>
                </div>

                <ProfilePhotoUploader photoUrl={profile.photoUrl} handleUpload={handlePhotoUpload} isDisabled={isProfileLocked}/>
                {!isProfileMinimized && (
                  <div className={`${isProfileLocked?'opacity-70 cursor-not-allowed':''}`}>
                    <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Sexo</span>
                        <select value={profile.sex} onChange={e=>handleProfileChange('sex',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}>
                          <option value="M">Masculino</option><option value="F">Feminino</option>
                        </select>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Idade</span>
                        <input type="number" value={profile.age}
                          min={INPUT_RANGES.age.min} max={INPUT_RANGES.age.max} step={INPUT_RANGES.age.step}
                          onChange={e=>handleProfileChange('age',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Peso (kg)</span>
                        <input type="number" value={profile.weight}
                          min={INPUT_RANGES.weight.min} max={INPUT_RANGES.weight.max} step={INPUT_RANGES.weight.step}
                          onChange={e=>handleProfileChange('weight',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Altura (cm)</span>
                        <input type="number" value={profile.height}
                          min={INPUT_RANGES.height.min} max={INPUT_RANGES.height.max} step={INPUT_RANGES.height.step}
                          onChange={e=>handleProfileChange('height',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}/>
                      </label>
                    </div>

                    <span className="text-slate-300 font-semibold text-sm block mb-3">Medidas (% Gordura)</span>
                    <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Pescoço (cm)</span>
                        <input type="number" value={profile.neck}
                          min={INPUT_RANGES.neck.min} max={INPUT_RANGES.neck.max} step={INPUT_RANGES.neck.step}
                          onChange={e=>handleProfileChange('neck',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Cintura (cm)</span>
                        <input type="number" value={profile.waist}
                          min={INPUT_RANGES.waist.min} max={INPUT_RANGES.waist.max} step={INPUT_RANGES.waist.step}
                          onChange={e=>handleProfileChange('waist',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}/>
                      </label>
                      {profile.sex==='F' && (
                        <label className="flex flex-col gap-1 col-span-2">
                          <span className="text-slate-300">Quadril (cm)</span>
                          <input type="number" value={profile.hip}
                            min={INPUT_RANGES.hip.min} max={INPUT_RANGES.hip.max} step={INPUT_RANGES.hip.step}
                            onChange={e=>handleProfileChange('hip',e.target.value)}
                            className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}/>
                        </label>
                      )}
                      <p className="text-slate-500 text-xs mt-1 col-span-2">
                        {bodyFat===null && (profile.sex==='F'
                          ? '⚠️ Altura, Pescoço, Cintura e Quadril são necessários para %BF feminino.'
                          : '⚠️ Altura, Pescoço e Cintura são necessários para %BF masculino.')}
                      </p>
                    </div>

                    <div className="grid grid-cols-1 gap-3 text-sm">
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Atividade</span>
                        <select value={profile.activity} onChange={e=>handleProfileChange('activity',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}>
                          <option value="sedentary">Sedentário</option>
                          <option value="light">Leve (1–3x/sem)</option>
                          <option value="moderate">Moderado (3–5x/sem)</option>
                          <option value="active">Ativo (6–7x/sem)</option>
                          <option value="very">Muito ativo</option>
                        </select>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span className="text-slate-300">Objetivo</span>
                        <select value={profile.goal} onChange={e=>handleProfileChange('goal',e.target.value)}
                          className="bg-slate-900 border border-slate-600 rounded px-2 py-2" disabled={isProfileLocked}>
                          <option value="loss">Emagrecer</option>
                          <option value="maintain">Manter</option>
                          <option value="gain">Ganhar</option>
                          <option value="recomp">Recomposição</option>
                        </select>
                      </label>
                    </div>

                    <div className="mt-4 grid grid-cols-2 gap-3 text-sm">{stats}</div>
                  </div>
                )}
              </div>

              {/* Metas */}
              <Section title="Metas de Macros" isMinimized={isMacrosMinimized}
                right={<MinimizeButton isMinimized={isMacrosMinimized} toggleMinimize={()=>setIsMacrosMinimized(p=>!p)}/>}>
                <Stat label="Calorias" value={totals.kcal} unit=" kcal" target={targetCalories}/>
                <Stat label="Proteínas" value={totals.protein} unit=" g" target={macroTargets.protein}/>
                <Stat label="Carboidratos" value={totals.carbs} unit=" g" target={macroTargets.carbs}/>
                <Stat label="Gorduras" value={totals.fats} unit=" g" target={macroTargets.fats}/>
                <div className="text-xs text-slate-400 mt-2">* Metas calculadas (P 1.8g/kg, G 0.8g/kg)</div>
              </Section>
            </div>

            {/* Coluna 2 */}
            <div className="lg:col-span-2 grid grid-cols-1 xl:grid-cols-2 gap-6">
              {/* Biblioteca */}
              <Section title="Biblioteca de Refeições" isMinimized={isLibraryMinimized}
                right={
                  <div className="flex items-center gap-2 flex-wrap justify-end">
                    <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Buscar..."
                      className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm w-full md:w-48"/>
                    <select value={selectedBlock} onChange={e=>setSelectedBlock(e.target.value)}
                      className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm">
                      <option value="all">Todos os blocos</option>
                      <option value="250">250 kcal</option>
                      <option value="350">350 kcal</option>
                      <option value="500">500 kcal</option>
                      <option value="750">750 kcal</option>
                    </select>
                    <MinimizeButton isMinimized={isLibraryMinimized} toggleMinimize={()=>setIsLibraryMinimized(p=>!p)}/>
                  </div>
                }>
                {loadError && (
                  <div className="mb-3 text-xs text-amber-300">
                    ⚠️ Falha ao carregar <code>alimentos.json</code>: {loadError}. Usando biblioteca interna de fallback.
                  </div>
                )}

                <div className="flex flex-wrap mb-3">
                  {TAGS.map(t=>(
                    <Pill key={t} active={activeTags.includes(t)} onClick={()=>{
                      setActiveTags(prev=> prev.includes(t) ? prev.filter(x=>x!==t) : [...prev,t]);
                    }}>{t}</Pill>
                  ))}
                  {activeTags.length>0 && (
                    <button onClick={()=>setActiveTags([])} className="text-xs text-slate-400 underline ml-2 hover:text-white">limpar tags</button>
                  )}
                </div>

                <div id="biblioteca" className="grid md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto pr-2">
                  {filteredMeals.map(m=>(
                    <div key={m.id} className="rounded-xl border border-slate-700 bg-slate-900 p-4">
                      <div className="flex items-start justify-between">
                        <div>
                          <div className="font-semibold text-slate-100">{m.name}</div>
                          <div className="text-sm text-slate-400">
                            {round(m.kcal)} kcal • P {round(m.protein)}g • C {round(m.carbs)}g • G {round(m.fats)}g
                          </div>
                        </div>
                        <span className="text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-300 border border-amber-500/40">{m.block} kcal</span>
                      </div>
                      <div className="mt-3 flex flex-wrap gap-2">
                        {m.tags.map(t=>(
                          <span key={t} className="text-xs px-2 py-1 rounded-full bg-slate-800 border border-slate-600 text-slate-300">{t}</span>
                        ))}
                      </div>
                      <div className="mt-4 flex flex-wrap gap-2">
                        {slotKeys.map(slotKey=>(
                          <button key={slotKey} onClick={()=>addTo(slotKey,m)}
                            className="text-xs px-2 py-1 rounded border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10">
                            + {getSlotLabel(slotKey)}
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                  {filteredMeals.length===0 && (
                    <div className="text-slate-400 text-sm md:col-span-2 p-4 border border-dashed border-slate-700 rounded-xl text-center">
                      Nenhuma refeição encontrada. Limpe filtros ou verifique o JSON.
                    </div>
                  )}
                </div>
              </Section>

              {/* Meu Dia */}
              <Section title="Meu Dia" isMinimized={isDayMinimized}
                right={
                  <div className="flex gap-2 flex-wrap justify-end">
                    <select value={currentDayId} onChange={e=>setCurrentDayId(e.target.value)}
                      className="bg-slate-900 border border-blue-600 rounded px-3 py-1 text-sm text-blue-300">
                      {dayOptions.map(id=><option key={id} value={id}>{getDayLabel(id)}</option>)}
                    </select>
                    <button onClick={duplicateCurrentDay}
                      className="text-sm px-3 py-1 rounded border border-purple-500 text-purple-300 hover:bg-purple-900/40">Duplicar Plano</button>
                    <button onClick={resetDay}
                      className="text-sm px-3 py-1 rounded border border-slate-600 text-slate-400 hover:bg-red-900/40">Resetar Conteúdo</button>
                    <button onClick={addSlot} disabled={slotKeys.length>=8}
                      className={`text-sm px-3 py-1 rounded border ${slotKeys.length>=8?'border-slate-700 text-slate-600':'border-blue-500 text-blue-300 hover:bg-blue-500/10'}`}>
                      + Refeição
                    </button>
                    <MinimizeButton isMinimized={isDayMinimized} toggleMinimize={()=>setIsDayMinimized(p=>!p)}/>
                  </div>
                }>
                <div id="meu-dia" className="grid md:grid-cols-1 gap-4 max-h-[500px] overflow-y-auto pr-2">
                  {slotKeys.map(slotKey=>(
                    <div key={slotKey} className="rounded-xl border border-slate-700 bg-slate-900 p-4">
                      <div className="flex justify-between items-center mb-2">
                        <div className="font-semibold text-slate-100">{getSlotLabel(slotKey)}</div>
                        {slotKeys.length>1 && (
                          <button onClick={()=>removeSlot(slotKey)}
                            className="text-xs px-2 py-1 rounded border border-red-700 text-red-500 hover:bg-red-900/20">Remover Slot</button>
                        )}
                      </div>

                      {(!day[slotKey] || day[slotKey].length===0) ? (
                        <div className="text-slate-500 text-sm p-4 border border-dashed border-slate-700 rounded-lg text-center">
                          Vazio — adicione refeições da biblioteca.
                        </div>
                      ) : (
                        <ul className="space-y-3">
                          {day[slotKey].map((entry,mIdx)=>(
                            <li key={mIdx} className={`p-3 border rounded-xl ${entry.isLocked?'border-emerald-500/50 bg-emerald-900/10':'border-slate-700 bg-slate-900/50'}`}>
                              <div className="flex justify-between items-start mb-3">
                                <div className="text-base text-emerald-400 font-bold flex items-center gap-2">
                                  {entry.name}
                                  {entry.isLocked && <svg className="w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/></svg>}
                                </div>
                                <div className="flex gap-2">
                                  <button onClick={()=>toggleLock(slotKey,mIdx)}
                                    className={`text-xs px-2 py-0.5 rounded border font-semibold
                                      ${entry.isLocked?'border-red-500 text-red-300 bg-red-900/20':'border-emerald-500 text-emerald-300 bg-emerald-900/20'}`}>
                                    {entry.isLocked?'Editar':'Feita'}
                                  </button>
                                  <button onClick={()=>removeMeal(slotKey,mIdx)}
                                    className="text-xs px-2 py-0.5 rounded border border-slate-600 text-s

