<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cardápio Inteligente (v5.7)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (produção) + erros detalhados -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX em navegador) -->
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    html, body, #root { min-height: 100vh; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif; }
  </style>
</head>
<body class="bg-[#0a0a1a] text-slate-200">
  <div id="root"></div>

  <!-- Airbag (overlay de erro) -->
  <script>
  (function () {
    function showOverlay(msg) {
      const pre = document.createElement('pre');
      pre.style.cssText = 'position:fixed;inset:0;margin:0;padding:16px;background:#0b1020;color:#ffb4b4;font:14px/1.5 ui-monospace,Consolas,monospace;z-index:99999;overflow:auto;white-space:pre-wrap';
      pre.textContent = 'Erro ao iniciar o app\n' + msg;
      document.body.appendChild(pre);
    }
    window.addEventListener('error', (e) => {
      const msg = `[global] ${e.message}\n${e.filename || ''}:${e.lineno || 0}:${e.colno || 0}`;
      console.error('[global error]', e.error || e);
      showOverlay(msg);
    });
    window.addEventListener('unhandledrejection', (e) => {
      console.error('[unhandledrejection]', e.reason);
      showOverlay('[promise] ' + (e.reason && e.reason.stack || e.reason));
    });
  })();
  </script>

  <!-- App -->
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    /* ------------------------- Utilidades ------------------------- */
    const KCAL_PER_G = { protein: 4, carbs: 4, fats: 9 };
    const round = (n, d = 0) => Math.round(n * 10**d) / 10**d;

    function calcBMR({ sex, weight, height, age }) {
      const s = sex === "F" ? -161 : 5;
      return 10 * weight + 6.25 * height - 5 * age + s;
    }
    function calcTDEE(bmr, activity) {
      const f = { sedentary:1.2, light:1.375, moderate:1.55, active:1.725, very:1.9 };
      return bmr * (f[activity] || 1.55);
    }
    function adjustForGoal(tdee, goal) {
      if (goal === "loss") return tdee * 0.85;
      if (goal === "gain") return tdee * 1.10;
      if (goal === "recomp") return tdee * 0.95;
      return tdee;
    }
    function deriveMacroTargets({ weight, calories }) {
      const protein = 1.8 * weight;
      const fat = 0.8 * weight;
      const kcalP = protein * KCAL_PER_G.protein;
      const kcalF = fat * KCAL_PER_G.fats;
      const kcalC = Math.max(0, calories - kcalP - kcalF);
      const carbs = kcalC / KCAL_PER_G.carbs;
      return { protein: round(protein), fats: round(fat), carbs: round(carbs) };
    }

    /* ------------------------- Storage ------------------------- */
    const PROFILE_STORAGE_KEY = "cardapio_profile_v5_3";
    const ALL_DAYS_STORAGE_KEY = "cardapio_all_days_v5_7";
    const SLOTS_STORAGE_KEY = "cardapio_slotkeys_v5_7";
    const CURRENT_DAY_ID_STORAGE_KEY = "cardapio_current_day_id_v5_7";
    const INITIAL_DAY_ID = 'day-1';
    const INITIAL_SLOT_KEYS = ['slot-1','slot-2','slot-3','slot-4'];

    const INPUT_RANGES = {
      age: { min: 10, max: 120, step: 1 },
      weight: { min: 30, max: 300, step: 0.5 },
      height: { min: 100, max: 250, step: 1 },
      neck: { min: 20, max: 60, step: 0.5 },
      waist:{ min: 40, max: 150, step: 0.5 },
      hip:  { min: 50, max: 150, step: 0.5 },
    };

    function normalizeAndValidateInput(key, value) {
      const r = INPUT_RANGES[key];
      let n = Number(value);
      if (isNaN(n) || value === null) n = 0;
      if (r) {
        if (n !== 0 && n < r.min) return r.min;
        if (n > r.max) return r.max;
      }
      return n;
    }

    function loadState(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (raw === null || raw === "undefined") return fallback;
        const v = JSON.parse(raw);
        if (key === PROFILE_STORAGE_KEY) {
          const validated = { ...v };
          let changed = false;
          Object.keys(INPUT_RANGES).forEach(k => {
            const r = INPUT_RANGES[k];
            const val = Number(v[k]);
            if (isNaN(val) || val < r.min || val > r.max) {
              validated[k] = DEFAULT_PROFILE[k];
              changed = true;
            }
          });
          if (!['M','F'].includes(v.sex))      { validated.sex = DEFAULT_PROFILE.sex; changed = true; }
          if (!['loss','maintain','gain','recomp'].includes(v.goal)) { validated.goal = DEFAULT_PROFILE.goal; changed = true; }
          if (changed) console.warn('Perfil ajustado por dados inválidos.');
          return validated;
        }
        return v;
      } catch (e) {
        console.warn('loadState falhou:', key, e);
        return fallback;
      }
    }
    function saveState(key, state) {
      try { localStorage.setItem(key, JSON.stringify(state)); }
      catch(e){ console.warn('saveState falhou', key, e); }
    }

    /* ------------------------- Perfil padrão ------------------------- */
    const DEFAULT_PROFILE = {
      sex: "M", age: 33, weight: 73, height: 170,
      activity: "moderate", goal: "recomp",
      neck: 36, waist: 85, hip: 95,
      photoUrl: 'https://placehold.co/100x100/1E293B/E2E8F0?text=Foto'
    };
    const getInitialDayState = (keys) => keys.reduce((acc,k)=> (acc[k]=[],acc),{});

    /* ----------------- Biblioteca interna (MEALS) ------------------ */
    const MEALS = [
      {
        id:"lib_whey", name:"Whey Isolado (Água)", block:"250", tags:["High Protein","Quick"],
        ingredients:[{ name:"Whey (1 scoop)", protein:25, carbs:5, fats:4, baseKcal:155 }]
      },
      {
        id:"lib_caseina", name:"Caseína Pré-cama", block:"250", tags:["High Protein","Night"],
        ingredients:[{ name:"Caseína", protein:30, carbs:4, fats:3, baseKcal:170 }]
      },
      {
        id:"lib_frango_br", name:"Frango + Arroz + Feijão", block:"500", tags:["Balanced","High Protein","BR"],
        ingredients:[
          { name:"Arroz (100g coz.)", protein:2, carbs:28, fats:1, baseKcal:130 },
          { name:"Feijão (100g coz.)", protein:5, carbs:15, fats:1, baseKcal:100 },
          { name:"Peito de frango (120g)", protein:34, carbs:0, fats:5, baseKcal:180 },
          { name:"Azeite (1 c.chá)", protein:0, carbs:0, fats:5, baseKcal:45 },
          { name:"Salada/legumes", protein:2, carbs:5, fats:0, baseKcal:30 }
        ]
      }
    ];

    /* ------------- Loader robusto do alimentos.json ---------------- */
    const JSON_URL = new URL('alimentos.json', location.href);

    function normalizeExternalItems(data) {
      if (!data || !Array.isArray(data.items)) return [];
      return data.items.map((it, i) => ({
        id: it.id || `ext_${i}`,
        name: it.nome || it.name || 'Item',
        block: String(Math.round(Number(it.kcal || 0) || 0)),
        tags: Array.isArray(it.tags) ? it.tags : [],
        ingredients: [{
          name: it.nome || it.name || 'Item',
          baseKcal: Number(it.kcal) || 0,
          protein: Number(it.protein) || 0,
          carbs:   Number(it.carbs)   || 0,
          fats:    Number(it.fats)    || 0,
          portion: 1
        }]
      }));
    }

    async function fetchExternalMealsSafe() {
      try {
        const u = new URL(JSON_URL);
        u.searchParams.set('_', String(Date.now()));
        const res = await fetch(u, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const data = JSON.parse(text);
        return normalizeExternalItems(data);
      } catch (err) {
        console.warn('alimentos.json indisponível/inválido:', err);
        return [];
      }
    }

    function withTotals(meals) {
      return meals.map(meal => {
        const ing = Array.isArray(meal.ingredients) ? meal.ingredients : [];
        const totals = ing.reduce((a, e) => {
          const p = Number(e.protein || 0), c = Number(e.carbs || 0), f = Number(e.fats || 0);
          const base = Number(e.baseKcal || (p*4 + c*4 + f*9));
          const por = Number(e.portion || 1);
          a.kcal += base * por; a.protein += p * por; a.carbs += c * por; a.fats += f * por;
          return a;
        }, { kcal:0, protein:0, carbs:0, fats:0 });
        return { ...meal, ...totals };
      });
    }

    /* --------------------- UI helpers --------------------- */
    const MinBtn = ({ on, toggle }) => (
      <button onClick={toggle} className="text-slate-400 hover:text-slate-200 p-1 rounded bg-slate-700/50 hover:bg-slate-700">
        <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          {on ? <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"/> :
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7"/>}
        </svg>
      </button>
    );
    const Section = ({ title, right, children }) => (
      <div className="bg-slate-800/70 rounded-2xl p-5 shadow border border-slate-700/50">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-slate-100 text-lg font-semibold">{title}</h2>
          {right}
        </div>
        {children}
      </div>
    );
    const Stat = ({ label, value, unit="", target }) => {
      const pct = Math.min(100, Math.max(0, (value / (target || 1)) * 100));
      const ok = target ? value <= target * 1.05 : true;
      return (
        <div className="mb-3">
          <div className="flex justify-between text-sm text-slate-300">
            <span>{label}</span>
            <span><strong className={ok?"text-green-400":"text-red-400"}>{round(value)}{unit}</strong>{target && <span className="text-slate-400"> / {round(target)}{unit}</span>}</span>
          </div>
          <div className="h-2 bg-slate-700 rounded">
            <div style={{ width: `${pct}%` }} className={`h-2 rounded ${ok?"bg-green-500":"bg-red-500"}`}/>
          </div>
        </div>
      );
    };

    /* ------------------------ App ------------------------ */
    function App() {
      // Perfil
      const [profile, setProfile] = useState(() => loadState(PROFILE_STORAGE_KEY, DEFAULT_PROFILE));
      const [isProfileLocked, setIsProfileLocked] = useState(false);

      // Slots & dias
      const [slotKeys, setSlotKeys] = useState(() => {
        const k = loadState(SLOTS_STORAGE_KEY, INITIAL_SLOT_KEYS);
        return Array.isArray(k) && k.length ? k : INITIAL_SLOT_KEYS;
      });
      const [currentDayId, setCurrentDayId] = useState(() => loadState(CURRENT_DAY_ID_STORAGE_KEY, INITIAL_DAY_ID));
      const [allDays, setAllDays] = useState(() => {
        const d = loadState(ALL_DAYS_STORAGE_KEY, {});
        if (!Object.keys(d).length || !d[INITIAL_DAY_ID]) return { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) };
        return d;
      });
      const day = allDays[currentDayId] || getInitialDayState(slotKeys);

      // Persist
      useEffect(()=> saveState(PROFILE_STORAGE_KEY, profile), [profile]);
      useEffect(()=> saveState(ALL_DAYS_STORAGE_KEY, allDays), [allDays]);
      useEffect(()=> saveState(CURRENT_DAY_ID_STORAGE_KEY, currentDayId), [currentDayId]);
      useEffect(()=> saveState(SLOTS_STORAGE_KEY, slotKeys), [slotKeys]);

      // Externo (alimentos.json)
      const [externalMeals, setExternalMeals] = useState([]);
      useEffect(()=>{ fetchExternalMealsSafe().then(setExternalMeals); }, []);

      // Filtros UI
      const [search, setSearch] = useState("");
      const [selectedBlock, setSelectedBlock] = useState("all");
      const [activeTags, setActiveTags] = useState([]);
      const [minProfile, setMinProfile] = useState(false);
      const [minMacros, setMinMacros] = useState(false);
      const [minLib, setMinLib] = useState(false);
      const [minDay, setMinDay] = useState(false);

      // Cálculos
      const bmr = useMemo(()=> calcBMR(profile), [profile]);
      const tdee = useMemo(()=> calcTDEE(bmr, profile.activity), [bmr, profile.activity]);
      const targetCalories = useMemo(()=> round(adjustForGoal(tdee, profile.goal)), [tdee, profile.goal]);
      const macroTargets = useMemo(()=> deriveMacroTargets({ weight: profile.weight, calories: targetCalories }), [profile.weight, targetCalories]);

      // Biblioteca mesclada (interna + externa) com totais
      const LIB_WITH_TOTALS = useMemo(()=> withTotals([...MEALS, ...externalMeals]), [externalMeals]);

      const filteredMeals = useMemo(()=>{
        return LIB_WITH_TOTALS.filter(m => {
          const blockOk  = selectedBlock === "all" || m.block === selectedBlock;
          const tagOk    = activeTags.length === 0 || activeTags.every(t => m.tags.includes(t));
          const searchOk = m.name.toLowerCase().includes(search.toLowerCase());
          return blockOk && tagOk && searchOk;
        });
      }, [LIB_WITH_TOTALS, selectedBlock, activeTags, search]);

      // Totais do dia
      const totals = useMemo(()=>{
        const items = Object.values(day).flat();
        return items.reduce((acc, meal) => {
          const ing = meal.ingredients || [];
          ing.forEach(e => {
            const p=Number(e.protein||0), c=Number(e.carbs||0), f=Number(e.fats||0);
            const base=Number(e.baseKcal || (p*4+c*4+f*9));
            const por=Number(e.portion||1);
            acc.kcal+=base*por; acc.protein+=p*por; acc.carbs+=c*por; acc.fats+=f*por;
          });
          return acc;
        }, { kcal:0, protein:0, carbs:0, fats:0 });
      }, [day]);

      // Helpers
      const getSlotLabel = (k)=> `Refeição ${slotKeys.indexOf(k)+1}`;
      const updateDay = (next)=> setAllDays(prev => ({ ...prev, [currentDayId]: next }));
      const addTo = (slotKey, meal)=> {
        const entry = { mealId: meal.id, name: meal.name, isLocked:false, ingredients: (meal.ingredients||[]).map(x=>({...x, portion:1})) };
        updateDay({ ...day, [slotKey]: [...(day[slotKey]||[]), entry] });
      };
      const removeMeal = (slotKey, i)=> updateDay({ ...day, [slotKey]: day[slotKey].filter((_,idx)=> idx!==i) });
      const toggleLock = (slotKey, i)=> updateDay({ ...day, [slotKey]: day[slotKey].map((m,idx)=> idx===i ? ({...m, isLocked:!m.isLocked}) : m) });
      const updateIngredientPortion = (slotKey, i, j, por)=> updateDay({
        ...day,
        [slotKey]: day[slotKey].map((m,idx)=> idx!==i || m.isLocked ? m :
          ({...m, ingredients: m.ingredients.map((ing,k)=> k===j? {...ing, portion:Number(por)} : ing)}))
      });
      const removeIngredient = (slotKey,i,j)=> updateDay({
        ...day,
        [slotKey]: day[slotKey].map((m,idx)=> {
          if (idx!==i || m.isLocked) return m;
          const next = m.ingredients.filter((_,k)=> k!==j);
          return next.length? {...m, ingredients:next} : null;
        }).filter(Boolean)
      });

      const addSlot = ()=> {
        if (slotKeys.length>=8) return;
        const key = `slot-${slotKeys.length+1}`;
        setSlotKeys(prev=> [...prev, key]);
        setAllDays(prev=>{
          const up = {...prev};
          Object.keys(up).forEach(did=> up[did] = { ...up[did], [key]: [] });
          return up;
        });
      };
      const removeSlot = (key)=> {
        if (slotKeys.length<=1) return;
        setSlotKeys(prev=> prev.filter(k=>k!==key));
        setAllDays(prev=>{
          const up = {...prev};
          Object.keys(up).forEach(did=> {
            const { [key]:_, ...rest } = up[did];
            up[did] = rest;
          });
          return up;
        });
      };
      const resetDay = ()=> updateDay(getInitialDayState(slotKeys));
      const duplicateCurrentDay = ()=> {
        const ids = Object.keys(allDays);
        const last = ids.reduce((mx,id)=> Math.max(mx, parseInt(id.split('-')[1]||'0',10)), 0);
        const newId = `day-${last+1}`;
        setAllDays(prev => ({ ...prev, [newId]: JSON.parse(JSON.stringify(day)) }));
        setCurrentDayId(newId);
      };
      const dayOptions = Object.keys(allDays).sort((a,b)=> (parseInt(a.split('-')[1]||'0',10) - parseInt(b.split('-')[1]||'0',10)));
      const getDayLabel = (id)=> `Dia ${dayOptions.indexOf(id)+1}`;

      const handleProfileChange = (key, value) => {
        if (isProfileLocked) return;
        const n = ['sex','activity','goal','photoUrl'].includes(key) ? value : normalizeAndValidateInput(key, value);
        setProfile(p => ({ ...p, [key]: n }));
      };
      const onPhoto = (e)=> {
        if (isProfileLocked) return;
        const f = e.target.files[0]; if (!f) return;
        const url = URL.createObjectURL(f);
        setProfile(p => ({ ...p, photoUrl:url }));
      };

      return (
        <div className="min-h-screen">
          <header className="px-6 py-5 border-b border-slate-700/60 sticky top-0 bg-[#0a0a1a]/90 backdrop-blur z-20">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">Cardápio Inteligente</h1>
                <p className="text-sm text-slate-400">Monte seu dia com porções ajustáveis e metas calculadas (v5.7)</p>
              </div>
              <div className="hidden md:flex items-center gap-3">
                <a href="#biblioteca" className="text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40">Biblioteca</a>
                <a href="#meu-dia" className="text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40">Meu Dia</a>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Coluna 1: Perfil + Metas */}
            <div className="lg:col-span-1 flex flex-col gap-6">
              <Section
                title="Seu Perfil"
                right={
                  <div className="flex gap-2">
                    <button onClick={()=> setIsProfileLocked(v=>!v)} className={`text-xs px-2 py-0.5 rounded border ${isProfileLocked ? 'border-red-500 text-red-300 bg-red-900/20' : 'border-emerald-500 text-emerald-300 bg-emerald-900/20'}`}>
                      {isProfileLocked ? 'Editar' : 'Trancar Perfil'}
                    </button>
                    <MinBtn on={minProfile} toggle={()=> setMinProfile(v=>!v)}/>
                  </div>
                }>
                {/* Foto sempre visível */}
                <div className={`flex flex-col items-center mb-4 ${isProfileLocked ? 'opacity-70' : ''}`}>
                  <label htmlFor="photo" className={isProfileLocked?'':'cursor-pointer'}>
                    <img src={profile.photoUrl} alt="Foto" className={`w-24 h-24 rounded-full object-cover border-4 border-slate-600 ${isProfileLocked?'':'hover:border-emerald-500'}`} onError={(e)=> e.target.src = DEFAULT_PROFILE.photoUrl}/>
                    <input id="photo" type="file" accept="image/*" onChange={onPhoto} className="hidden" disabled={isProfileLocked}/>
                  </label>
                  <p className="text-xs text-slate-400 mt-2">{isProfileLocked?'Informações fixadas':'Clique para alterar foto'}</p>
                </div>

                {!minProfile && (
                  <>
                    <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                      <label className="flex flex-col gap-1">
                        <span>Sexo</span>
                        <select value={profile.sex} disabled={isProfileLocked}
                                onChange={(e)=> handleProfileChange('sex', e.target.value)}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-2">
                          <option value="M">Masculino</option>
                          <option value="F">Feminino</option>
                        </select>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Idade</span>
                        <input type="number" value={profile.age} disabled={isProfileLocked}
                               onChange={(e)=> handleProfileChange('age', e.target.value)}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2"/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Peso (kg)</span>
                        <input type="number" value={profile.weight} disabled={isProfileLocked}
                               onChange={(e)=> handleProfileChange('weight', e.target.value)}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2"/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Altura (cm)</span>
                        <input type="number" value={profile.height} disabled={isProfileLocked}
                               onChange={(e)=> handleProfileChange('height', e.target.value)}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2"/>
                      </label>
                    </div>

                    <span className="text-slate-300 font-semibold text-sm block mb-3">Medidas (p/ %Gordura)</span>
                    <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                      <label className="flex flex-col gap-1">
                        <span>Pescoço (cm)</span>
                        <input type="number" value={profile.neck} disabled={isProfileLocked}
                               onChange={(e)=> handleProfileChange('neck', e.target.value)}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2"/>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Cintura (cm)</span>
                        <input type="number" value={profile.waist} disabled={isProfileLocked}
                               onChange={(e)=> handleProfileChange('waist', e.target.value)}
                               className="bg-slate-900 border border-slate-600 rounded px-2 py-2"/>
                      </label>
                      {profile.sex==='F' && (
                        <label className="flex flex-col gap-1 col-span-2">
                          <span>Quadril (cm)</span>
                          <input type="number" value={profile.hip} disabled={isProfileLocked}
                                 onChange={(e)=> handleProfileChange('hip', e.target.value)}
                                 className="bg-slate-900 border border-slate-600 rounded px-2 py-2"/>
                        </label>
                      )}
                    </div>

                    <div className="grid grid-cols-1 gap-3 text-sm">
                      <label className="flex flex-col gap-1">
                        <span>Nível de Atividade</span>
                        <select value={profile.activity} disabled={isProfileLocked}
                                onChange={(e)=> handleProfileChange('activity', e.target.value)}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-2">
                          <option value="sedentary">Sedentário</option>
                          <option value="light">Leve (1–3x/sem)</option>
                          <option value="moderate">Moderado (3–5x/sem)</option>
                          <option value="active">Ativo (6–7x/sem)</option>
                          <option value="very">Muito ativo</option>
                        </select>
                      </label>
                      <label className="flex flex-col gap-1">
                        <span>Objetivo</span>
                        <select value={profile.goal} disabled={isProfileLocked}
                                onChange={(e)=> handleProfileChange('goal', e.target.value)}
                                className="bg-slate-900 border border-slate-600 rounded px-2 py-2">
                          <option value="loss">Emagrecer (déficit)</option>
                          <option value="maintain">Manter</option>
                          <option value="gain">Ganhar (superávit)</option>
                          <option value="recomp">Recomposição</option>
                        </select>
                      </label>
                    </div>

                    <div className="mt-4 grid grid-cols-2 gap-3 text-sm">
                      <div className="p-3 rounded bg-slate-900 border border-slate-700">
                        <div className="text-slate-400">TDEE alvo</div>
                        <div className="text-xl font-semibold text-emerald-400">{round(targetCalories)}</div>
                        <div className="text-slate-500 text-xs">kcal/dia</div>
                      </div>
                      <div className="p-3 rounded bg-slate-900 border border-slate-700">
                        <div className="text-slate-400">Macros alvo</div>
                        <div className="text-sm text-slate-300">P {macroTargets.protein} • C {macroTargets.carbs} • G {macroTargets.fats}</div>
                      </div>
                    </div>
                  </>
                )}
              </Section>

              <Section
                title="Metas de Macros"
                right={<MinBtn on={minMacros} toggle={()=> setMinMacros(v=>!v)}/>}>
                {!minMacros && (
                  <>
                    <Stat label="Calorias"   value={totals.kcal}   unit=" kcal" target={targetCalories}/>
                    <Stat label="Proteínas"  value={totals.protein} unit=" g"    target={macroTargets.protein}/>
                    <Stat label="Carboidratos" value={totals.carbs} unit=" g"    target={macroTargets.carbs}/>
                    <Stat label="Gorduras"   value={totals.fats}   unit=" g"    target={macroTargets.fats}/>
                  </>
                )}
              </Section>
            </div>

            {/* Coluna 2: Biblioteca + Meu Dia */}
            <div className="lg:col-span-2 grid grid-cols-1 xl:grid-cols-2 gap-6">
              <Section
                title="Biblioteca de Refeições"
                right={
                  <div className="flex items-center gap-2 flex-wrap justify-end">
                    <input value={search} onChange={(e)=> setSearch(e.target.value)} placeholder="Buscar..."
                           className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm w-48"/>
                    <select value={selectedBlock} onChange={(e)=> setSelectedBlock(e.target.value)}
                            className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm">
                      <option value="all">Todos</option>
                      <option value="250">250</option>
                      <option value="350">350</option>
                      <option value="500">500</option>
                      <option value="750">750</option>
                    </select>
                    <MinBtn on={minLib} toggle={()=> setMinLib(v=>!v)}/>
                  </div>
                }>
                {!minLib && (
                  <div id="biblioteca" className="grid md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto pr-2">
                    {filteredMeals.map(m => (
                      <div key={m.id} className="rounded-xl border border-slate-700 bg-slate-900 p-4">
                        <div className="flex items-start justify-between">
                          <div>
                            <div className="font-semibold text-slate-100">{m.name}</div>
                            <div className="text-sm text-slate-400">
                              {round(m.kcal)} kcal • P {round(m.protein)}g • C {round(m.carbs)}g • G {round(m.fats)}g
                            </div>
                          </div>
                          <span className="text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-300 border border-amber-500/40">{m.block} kcal</span>
                        </div>
                        <div className="mt-3 flex flex-wrap gap-2">
                          {(m.tags||[]).map(t => (
                            <span key={t} className="text-xs px-2 py-1 rounded-full bg-slate-800 border border-slate-600 text-slate-300">{t}</span>
                          ))}
                        </div>
                        <div className="mt-4 flex flex-wrap gap-2">
                          {slotKeys.map(k => (
                            <button key={k} onClick={()=> addTo(k, m)}
                                    className="text-xs px-2 py-1 rounded border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10">
                              + {`Refeição ${slotKeys.indexOf(k)+1}`}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                    {filteredMeals.length===0 && (
                      <div className="text-slate-400 text-sm md:col-span-2 p-4 border border-dashed border-slate-700 rounded-xl text-center">
                        Nenhuma refeição encontrada. Ajuste filtros.
                      </div>
                    )}
                  </div>
                )}
              </Section>

              <Section
                title="Meu Dia"
                right={
                  <div className="flex gap-2 flex-wrap justify-end">
                    <select value={currentDayId} onChange={(e)=> setCurrentDayId(e.target.value)}
                            className="bg-slate-900 border border-blue-600 rounded px-3 py-1 text-sm text-blue-300 font-semibold">
                      {dayOptions.map(id => <option key={id} value={id}>{getDayLabel(id)}</option>)}
                    </select>
                    <button onClick={duplicateCurrentDay} className="text-sm px-3 py-1 rounded border border-purple-500 text-purple-300 hover:bg-purple-900/40">Duplicar</button>
                    <button onClick={resetDay} className="text-sm px-3 py-1 rounded border border-slate-600 text-slate-400 hover:bg-red-900/40">Resetar</button>
                    <button onClick={addSlot} disabled={slotKeys.length>=8}
                            className={`text-sm px-3 py-1 rounded border ${slotKeys.length>=8?'border-slate-700 text-slate-600 cursor-not-allowed':'border-blue-500 text-blue-300 hover:bg-blue-500/10'}`}>
                      + Refeição
                    </button>
                    <MinBtn on={minDay} toggle={()=> setMinDay(v=>!v)}/>
                  </div>
                }>
                {!minDay && (
                  <div id="meu-dia" className="grid md:grid-cols-1 gap-4 max-h-[500px] overflow-y-auto pr-2">
                    {slotKeys.map(key => (
                      <div key={key} className="rounded-xl border border-slate-700 bg-slate-900 p-4">
                        <div className="flex justify-between items-center mb-2">
                          <div className="font-semibold text-slate-100">{getSlotLabel(key)}</div>
                          {slotKeys.length>1 && (
                            <button onClick={()=> removeSlot(key)} className="text-xs px-2 py-1 rounded border border-red-700 text-red-500 hover:bg-red-900/20">
                              Remover Slot
                            </button>
                          )}
                        </div>

                        {(!day[key] || day[key].length===0) ? (
                          <div className="text-slate-500 text-sm p-4 border border-dashed border-slate-700 rounded-lg text-center">
                            Vazio — adicione refeições da biblioteca.
                          </div>
                        ) : (
                          <ul className="space-y-3">
                            {day[key].map((meal, i) => (
                              <li key={i} className={`p-3 border rounded-xl ${meal.isLocked?'border-emerald-500/50 bg-emerald-900/10':'border-slate-700 bg-slate-900/50'}`}>
                                <div className="flex justify-between items-start mb-3">
                                  <div className="text-base text-emerald-400 font-bold flex items-center gap-2">
                                    {meal.name}
                                    {meal.isLocked && (
                                      <svg className="w-4 h-4 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path>
                                      </svg>
                                    )}
                                  </div>
                                  <div className="flex gap-2 items-center">
                                    <button onClick={()=> toggleLock(key, i)}
                                            className={`text-xs px-2 py-0.5 rounded border ${meal.isLocked?'border-red-500 text-red-300 bg-red-900/20':'border-emerald-500 text-emerald-300 bg-emerald-900/20'}`}>
                                      {meal.isLocked?'Editar':'Feita'}
                                    </button>
                                    <button onClick={()=> removeMeal(key, i)} className="text-xs px-2 py-0.5 rounded border border-slate-600 text-slate-400 hover:bg-red-500/10">
                                      Remover
                                    </button>
                                  </div>
                                </div>

                                <p className="text-xs text-slate-400 mb-2 font-medium">Ingredientes:</p>
                                <ul className="space-y-2">
                                  {(meal.ingredients||[]).map((ing, j) => {
                                    const p=Number(ing.protein||0), c=Number(ing.carbs||0), f=Number(ing.fats||0);
                                    const base=Number(ing.baseKcal || (p*4+c*4+f*9));
                                    const por=Number(ing.portion||1);
                                    const kcal = base*por;
                                    const disabled = meal.isLocked;
                                    return (
                                      <li key={j} className={`flex justify-between items-center text-xs pl-3 py-1 border-l-2 ${disabled?'border-emerald-500/50':'border-slate-700 hover:bg-slate-800/50'}`}>
                                        <div className="text-slate-300 flex-1 truncate">{ing.name} (<strong className="text-slate-200">{round(kcal)} kcal</strong>)</div>
                                        <div className="flex items-center gap-2">
                                          <select value={ing.portion} disabled={disabled}
                                                  onChange={(e)=> updateIngredientPortion(key, i, j, e.target.value)}
                                                  className={`bg-slate-700 border rounded px-1 py-0.5 text-xs w-20 ${disabled?'opacity-50 cursor-not-allowed border-slate-700':'border-slate-600'}`}>
                                            {[0.5,1,1.5,2].map(v => <option key={v} value={v}>{v}x</option>)}
                                          </select>
                                          <button onClick={()=> removeIngredient(key, i, j)} disabled={disabled}
                                                  className={`text-xs p-1 rounded ${disabled?'text-slate-600 cursor-not-allowed':'text-red-400 hover:text-red-300 hover:bg-red-900/20'}`}>
                                            <svg className="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd"/></svg>
                                          </button>
                                        </div>
                                      </li>
                                    );
                                  })}
                                </ul>
                              </li>
                            ))}
                          </ul>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 border-t border-slate-700 pt-4">
                  <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Calorias</div><div className="text-xl font-bold">{round(totals.kcal)}</div></div>
                  <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Proteínas</div><div className="text-xl font-bold">{round(totals.protein)} g</div></div>
                  <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Carboidratos</div><div className="text-xl font-bold">{round(totals.carbs)} g</div></div>
                  <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Gorduras</div><div className="text-xl font-bold">{round(totals.fats)} g</div></div>
                </div>
              </Section>
            </div>
          </main>

          <footer className="max-w-7xl mx-auto px-6 py-10 text-center text-xs text-slate-500">
            MVP visual v5.7. Perfis locais independentes + cardápio carregado via JSON.
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
